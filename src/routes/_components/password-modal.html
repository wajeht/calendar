<div class="modal-overlay" id="passwordModalOverlay"></div>
<div class="modal" id="passwordModal" style="max-width: 450px">
    <div class="modal-header">
        <h2>Authentication Required</h2>
        <button class="modal-close" onclick="passwordModal.close()">Ã—</button>
    </div>
    <div class="modal-body">
        <div class="fc-form">
            <p style="margin-bottom: 16px; color: #666; font-size: 13px">
                Enter password to access settings
            </p>
            <div class="fc-form-group">
                <input
                    type="password"
                    id="password-input"
                    placeholder="Enter password"
                    onkeyup="if(event.key==='Enter') passwordModal.login()"
                />
            </div>
            <button
                onclick="passwordModal.login()"
                class="fc-button fc-button-primary"
                style="width: 100%"
            >
                Login
            </button>
            <div id="password-error" class="error-message">Incorrect password</div>
        </div>
    </div>
</div>

<script>
    class PasswordModal {
        constructor() {
            this.modal = document.getElementById("passwordModal");
            this.overlay = document.getElementById("passwordModalOverlay");
            this.passwordInput = document.getElementById("password-input");
            this.errorEl = document.getElementById("password-error");
            this.isOpen = false;

            this.setupEventListeners();
        }

        setupEventListeners() {
            this.passwordInput.addEventListener("keyup", (e) => {
                if (e.key === "Enter") {
                    this.login();
                }
            });

            this.overlay.addEventListener("click", () => {
                this.close();
            });
        }

        async login() {
            const password = this.passwordInput.value;
            this.hideError();

            try {
                const response = await fetch("/api/auth", {
                    method: "POST",
                    credentials: "include",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ password }),
                });

                if (response.ok) {
                    this.close();
                    if (typeof isAuthenticated !== "undefined") {
                        isAuthenticated = true;
                    }
                    if (typeof sharedCalendarData !== "undefined") {
                        sharedCalendarData = [];
                    }
                    if (typeof updateToolbar === "function") {
                        updateToolbar();
                    }
                    if (typeof loadCalendars === "function") {
                        await loadCalendars(); // Refresh calendar with authenticated data
                    }
                    if (typeof settingsModal !== "undefined") {
                        settingsModal.show();
                    }
                    if (typeof toast !== "undefined") {
                        toast.success("Successfully authenticated");
                    }
                } else {
                    try {
                        const errorData = await response.json();
                        if (errorData.errors && errorData.errors.password) {
                            this.showError(errorData.errors.password);
                        } else {
                            this.showError(errorData.error || "Authentication failed");
                        }
                    } catch (parseError) {
                        this.showError("Authentication failed");
                    }
                }
            } catch (error) {
                this.showError("Connection error");
            }
        }

        show() {
            this.isOpen = true;
            this.modal.classList.add("show");
            this.overlay.classList.add("show");
            this.passwordInput.value = "";
            this.hideError();
            this.passwordInput.focus();

            if (typeof modalStack !== "undefined") {
                modalStack.push(this);
            }
        }

        close() {
            this.isOpen = false;
            this.modal.classList.remove("show");
            this.overlay.classList.remove("show");

            if (typeof modalStack !== "undefined") {
                modalStack.remove(this);
            }
        }

        showError(message = "Incorrect password") {
            this.errorEl.textContent = message;
            this.errorEl.style.display = "block";
            this.passwordInput.value = "";
            this.passwordInput.focus();
        }

        hideError() {
            this.errorEl.style.display = "none";
        }
    }

    const passwordModal = new PasswordModal();
</script>
