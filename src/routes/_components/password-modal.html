<div class="modal-overlay" id="passwordModalOverlay"></div>
<div class="modal" id="passwordModal" style="max-width: 400px;">
    <div class="modal-header">
        <h2>Authentication Required</h2>
    </div>
    <div class="modal-body">
        <div class="fc-form">
            <p style="margin-bottom: 16px; color: #666; font-size: 13px;">Enter password to access settings</p>
            <div class="fc-form-group">
                <input type="password" id="password-input" placeholder="Enter password" onkeyup="if(event.key==='Enter') passwordModal.login()">
            </div>
            <button onclick="passwordModal.login()" class="fc-button fc-button-primary" style="width: 100%;">Login</button>
            <div id="password-error" class="error-message">Incorrect password</div>
        </div>
    </div>
</div>

<script>
class PasswordModal {
    constructor() {
        this.modal = document.getElementById('passwordModal');
        this.overlay = document.getElementById('passwordModalOverlay');
        this.passwordInput = document.getElementById('password-input');
        this.errorEl = document.getElementById('password-error');
        this.isOpen = false;

        this.setupEventListeners();
    }

    setupEventListeners() {
        // Enter key in password input
        this.passwordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                this.login();
            }
        });

        // Escape key to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) {
                this.close();
            }
        });

        // Overlay click to close
        this.overlay.addEventListener('click', () => {
            this.close();
        });
    }

    async login() {
        const password = this.passwordInput.value;
        this.hideError();

        try {
            const response = await fetch('/api/auth', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password })
            });

            if (response.ok) {
                this.close();
                if (typeof isAuthenticated !== 'undefined') {
                    isAuthenticated = true;
                }
                if (typeof calendarModals !== 'undefined') {
                    calendarModals.management.show();
                }
                if (typeof toast !== 'undefined') {
                    toast.success('Successfully authenticated');
                }
            } else {
                this.showError();
            }
        } catch (error) {
            this.showError();
        }
    }

    show() {
        this.isOpen = true;
        this.modal.classList.add('show');
        this.overlay.classList.add('show');
        this.passwordInput.value = '';
        this.hideError();
        this.passwordInput.focus();
    }

    close() {
        this.isOpen = false;
        this.modal.classList.remove('show');
        this.overlay.classList.remove('show');
    }

    showError() {
        this.errorEl.style.display = 'block';
        this.passwordInput.value = '';
        this.passwordInput.focus();
    }

    hideError() {
        this.errorEl.style.display = 'none';
    }
}

// Global password modal instance
const passwordModal = new PasswordModal();
</script>
