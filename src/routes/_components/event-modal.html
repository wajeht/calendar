<div class="modal-overlay" id="eventModalOverlay"></div>
<div class="modal" id="eventModal" style="max-width: 500px;">
    <div class="modal-header">
        <h2 id="eventTitle">Event Details</h2>
        <button class="modal-close" onclick="eventModal.close()">Ã—</button>
    </div>
    <div class="modal-body">
        <div id="eventDetails"></div>
    </div>
</div>

<script>
class EventModal {
    constructor() {
        this.modal = document.getElementById('eventModal');
        this.overlay = document.getElementById('eventModalOverlay');
        this.titleEl = document.getElementById('eventTitle');
        this.detailsEl = document.getElementById('eventDetails');
        this.isOpen = false;

        this.setupEventListeners();
    }

    setupEventListeners() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) {
                this.close();
            }
        });

        this.overlay.addEventListener('click', () => {
            this.close();
        });
    }

    show(event, sourceCalendar = null) {
        this.isOpen = true;
        this.titleEl.textContent = event.title || 'Event Details';

        const detailsHTML = this.buildEventDetails(event, sourceCalendar);
        this.detailsEl.innerHTML = detailsHTML;

        this.modal.classList.add('show');
        this.overlay.classList.add('show');
    }

    close() {
        this.isOpen = false;
        this.modal.classList.remove('show');
        this.overlay.classList.remove('show');
    }

    buildEventDetails(event, sourceCalendar = null) {
        const details = [];

        // Date and time information
        if (event.allDay) {
            details.push(`<div class="event-detail"><label>When:</label> All day event</div>`);
        }

        details.push(`<div class="event-detail"><label>Start:</label> ${this.formatDate(event.start, event.allDay)}</div>`);

        if (event.end) {
            details.push(`<div class="event-detail"><label>End:</label> ${this.formatDate(event.end, event.allDay)}</div>`);
        }

        // Duration calculation
        if (event.start && event.end && !event.allDay) {
            const duration = (event.end - event.start) / 1000 / 60;
            if (duration < 60) {
                details.push(`<div class="event-detail"><label>Duration:</label> ${duration} minutes</div>`);
            } else {
                const hours = Math.floor(duration / 60);
                const mins = duration % 60;
                details.push(`<div class="event-detail"><label>Duration:</label> ${hours}h ${mins > 0 ? mins + 'm' : ''}</div>`);
            }
        }

        // Location
        if (event.extendedProps && event.extendedProps.location) {
            const locationWithLinks = this.linkify(event.extendedProps.location);
            details.push(`<div class="event-detail"><label>Location:</label> ${locationWithLinks}</div>`);
        }

        // Description
        if (event.extendedProps && event.extendedProps.description) {
            const descriptionWithLinks = this.linkify(event.extendedProps.description);
            details.push(`<div class="event-detail"><label>Description:</label><br>${descriptionWithLinks}</div>`);
        }

        // Status
        if (event.extendedProps && event.extendedProps.status) {
            details.push(`<div class="event-detail"><label>Status:</label> ${event.extendedProps.status}</div>`);
        }

        // Organizer
        if (event.extendedProps && (event.extendedProps.organizerName || event.extendedProps.organizerEmail)) {
            const organizerParts = [];
            if (event.extendedProps.organizerName) {
                organizerParts.push(event.extendedProps.organizerName);
            }
            if (event.extendedProps.organizerEmail) {
                const emailLink = `<a href="mailto:${event.extendedProps.organizerEmail}">${event.extendedProps.organizerEmail}</a>`;
                organizerParts.push(organizerParts.length > 0 ? ` (${emailLink})` : emailLink);
            }
            details.push(`<div class="event-detail"><label>Organizer:</label> ${organizerParts.join('')}</div>`);
        }

        // Attendees
        if (event.extendedProps && event.extendedProps.attendeeCount && parseInt(event.extendedProps.attendeeCount) > 0) {
            details.push(`<div class="event-detail"><label>Attendees:</label> ${event.extendedProps.attendeeCount} attendee(s)</div>`);

            if (event.extendedProps.attendeeNames) {
                details.push(`<div class="event-detail"><label>Names:</label> ${event.extendedProps.attendeeNames}</div>`);
            }

            if (event.extendedProps.attendeeEmails) {
                const emails = event.extendedProps.attendeeEmails.split(', ');
                const emailParts = [];
                for (let i = 0; i < emails.length; i++) {
                    emailParts[i] = `<a href="mailto:${emails[i]}">${emails[i]}</a>`;
                }
                details.push(`<div class="event-detail"><label>Emails:</label> ${emailParts.join(', ')}</div>`);
            }
        }

        // Transparency
        if (event.extendedProps && event.extendedProps.transparency) {
            const transparencyText = event.extendedProps.transparency === 'OPAQUE' ? 'Busy' : 'Free';
            details.push(`<div class="event-detail"><label>Show as:</label> ${transparencyText}</div>`);
        }

        // Timestamps
        if (event.extendedProps && event.extendedProps.created) {
            const createdDate = new Date(event.extendedProps.created);
            details.push(`<div class="event-detail"><label>Created:</label> ${createdDate.toLocaleString()}</div>`);
        }

        if (event.extendedProps && event.extendedProps.lastModified) {
            const modifiedDate = new Date(event.extendedProps.lastModified);
            details.push(`<div class="event-detail"><label>Modified:</label> ${modifiedDate.toLocaleString()}</div>`);
        }

        // Event UID
        if (event.extendedProps && event.extendedProps.uid) {
            details.push(`<div class="event-detail"><label>Event ID:</label> <code style="font-size: 0.8em; background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">${event.extendedProps.uid}</code></div>`);
        }

        // Calendar source
        if (sourceCalendar) {
            const calendarDisplayName = sourceCalendar.name || 'Unknown Calendar';
            details.push(`<div class="event-detail"><label>Calendar:</label> <span style="display:inline-block; width:12px; height:12px; background:${sourceCalendar.color}; border-radius:2px;"></span> ${calendarDisplayName}</div>`);
        }

        // Event URL
        if (event.url) {
            details.push(`<div class="event-detail"><label>Link:</label> <a href="${event.url}" target="_blank" rel="noopener noreferrer">Open in calendar</a></div>`);
        }

        return details.join('');
    }

    formatDate(date, allDay = false) {
        if (!date) return 'N/A';
        return date.toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: allDay ? undefined : '2-digit',
            minute: allDay ? undefined : '2-digit'
        });
    }

    linkify(text) {
        if (!text) return text;

        const words = text.split(/(\s+)/);

        const resultWords = [];
        for (let i = 0; i < words.length; i++) {
            const word = words[i];
            if (/^\s+$/.test(word)) {
                resultWords[i] = word;
                continue;
            }

            let potentialContact = word;
            let trailingPunctuation = '';

            const punctuationMatch = word.match(/^(.+?)([.,;:!?)\]}>]+)$/);
            if (punctuationMatch) {
                potentialContact = punctuationMatch[1];
                trailingPunctuation = punctuationMatch[2];
            }

            // Email detection
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (emailRegex.test(potentialContact)) {
                resultWords[i] = `<a href="mailto:${potentialContact}">${potentialContact}</a>${trailingPunctuation}`;
                continue;
            }

            // Phone number detection
            const phoneRegex = /^(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
            const phoneMatch = potentialContact.match(phoneRegex);
            if (phoneMatch) {
                const cleanPhone = potentialContact.replace(/[^\d+]/g, '');
                resultWords[i] = `<a href="tel:${cleanPhone}">${potentialContact}</a>${trailingPunctuation}`;
                continue;
            }

            // URL detection
            try {
                const url = new URL(potentialContact);
                if (url.protocol === 'http:' || url.protocol === 'https:') {
                    resultWords[i] = `<a href="${url.href}" target="_blank" rel="noopener noreferrer">${potentialContact}</a>${trailingPunctuation}`;
                    continue;
                }
            } catch (e) { }

            resultWords[i] = word;
        }
        return resultWords.join('');
    }
}

const eventModal = new EventModal();
</script>
