<div id="calendar"></div>

<%- include('../_components/password-modal.html') %>

<style>
/* Calendar Management Modal Styles */
.calendar-modal-overlay, .add-calendar-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 3000;
}

.calendar-modal-overlay.show, .add-calendar-modal-overlay.show {
    display: block;
}

.calendar-modal, .add-calendar-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 3001;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.calendar-modal.show, .add-calendar-modal.show {
    display: block;
}

.calendar-modal h2, .add-calendar-modal h2 {
    margin-top: 0;
    margin-bottom: 20px;
    text-align: center;
}

.calendar-modal-close, .add-calendar-modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.calendar-modal-close:hover, .add-calendar-modal-close:hover {
    color: #000;
}

.calendar-actions {
    margin-top: 20px;
    text-align: center;
}

.calendar-actions button {
    margin: 0 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

/* Add Calendar Form Styles */
.add-calendar-form {
    max-width: 400px;
    margin: 0 auto;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.form-group input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

.form-group input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.form-actions {
    text-align: center;
    margin-top: 20px;
}

.form-actions button {
    margin: 0 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

/* Event Modal Styles */
.event-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 3000;
}

.event-modal-overlay.show {
    display: block;
}

.event-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 3001;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.event-modal.show {
    display: block;
}

.event-modal h2 {
    margin-top: 0;
    margin-bottom: 20px;
}

.event-modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.event-modal-close:hover {
    color: #000;
}

.event-detail {
    margin-bottom: 15px;
    line-height: 1.5;
}

.event-detail label {
    font-weight: bold;
    color: #333;
    margin-right: 10px;
}

.event-detail a {
    color: #007bff;
    text-decoration: none;
}

.event-detail a:hover {
    text-decoration: underline;
}
</style>

<!-- Calendar Management Modal -->
<div class="calendar-modal-overlay" id="calendarModalOverlay"></div>
<div class="calendar-modal" id="calendarModal">
    <button class="calendar-modal-close" onclick="closeCalendarManagementModal()">×</button>
    <h2>Manage Calendars</h2>
    <div class="calendar-modal-content">
        <div class="calendar-list" id="calendarList">
            <!-- Calendar list will be populated here -->
        </div>
        <div class="calendar-actions">
            <button onclick="showAddCalendarForm()" class="btn-primary">Add Calendar</button>
            <button onclick="closeCalendarManagementModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Add Calendar Form Modal -->
<div class="add-calendar-modal-overlay" id="addCalendarModalOverlay"></div>
<div class="add-calendar-modal" id="addCalendarModal">
    <button class="add-calendar-modal-close" onclick="closeAddCalendarModal()">×</button>
    <h2>Add New Calendar</h2>
    <div class="add-calendar-form">
        <div class="form-group">
            <label for="calendar-name">Name:</label>
            <input type="text" id="calendar-name" placeholder="Calendar name" required>
        </div>
        <div class="form-group">
            <label for="calendar-url">URL:</label>
            <input type="url" id="calendar-url" placeholder="https://example.com/calendar.ics" required>
        </div>
        <div class="form-group">
            <label for="calendar-color">Color:</label>
            <input type="color" id="calendar-color" value="#3498db">
        </div>
        <div class="form-actions">
            <button onclick="addCalendar()" class="btn-primary">Add Calendar</button>
            <button onclick="closeAddCalendarModal()" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<div class="event-modal-overlay" id="eventModalOverlay"></div>
<div class="event-modal" id="eventModal">
    <button class="event-modal-close" onclick="closeEventModal()">x</button>
    <h2 id="eventTitle">Event Details</h2>
    <div id="eventDetails"></div>
</div>

<script>
    let calendar;
    let eventSources = [];
    let isAuthenticated = false;

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');

        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        const dateParam = urlParams.get('date');

        let initialView = 'timeGridWeek';
        if (viewParam) {
            switch (viewParam) {
                case 'month':
                    initialView = 'dayGridMonth';
                    break;
                case 'week':
                    initialView = 'timeGridWeek';
                    break;
                case 'day':
                    initialView = 'timeGridDay';
                    break;
                case 'list':
                    initialView = 'listMonth';
                    break;
            }
        }

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: initialView,
            initialDate: dateParam || undefined,
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth refetchButton settingsButton'
            },
            customButtons: {
                refetchButton: {
                    text: 'refetch',
                    hint: 'Refetch All Calendars',
                    click: function () {
                        refetchAllCalendars();
                    }
                },
                settingsButton: {
                    text: 'settings',
                    hint: 'Manage Calendars',
                    click: function () {
                        if (isAuthenticated) {
                            showCalendarManagementModal();
                        } else {
                            showPasswordModal();
                        }
                    }
                }
            },
            height: '100%',
            nowIndicator: true,
            expandRows: true,
            editable: false,
            selectable: false,
            selectMirror: false,
            businessHours: {
                daysOfWeek: [1, 2, 3, 4, 5], // Monday - Friday
                startTime: '09:00',
                endTime: '17:00'
            },
            eventSources: [],
            eventClick: function (info) {
                info.jsEvent.preventDefault();

                const eventSourceUrl = info.event.source?.url || info.event.source?.internalEventSource?.meta?.url;
                log.debug('Event source URL:', eventSourceUrl, 'Event color:', info.event.backgroundColor);

                const sourceCalendar = eventSources.find(es => {
                    return es.color === info.event.backgroundColor ||
                        (es.source && es.source.url === eventSourceUrl);
                });

                log.debug('Found calendar:', sourceCalendar, 'Auth:', isAuthenticated);

                if (!isAuthenticated && sourceCalendar && sourceCalendar.details) {
                    log.public('Details hidden for public view');
                    return;
                }

                openEventModal(info.event);
            },
            loading: function (isLoading) {
                if (isLoading) {
                    log.debug('Loading calendar...');
                }
            },
            eventSourceFailure: function (error) {
                log.error('Calendar load failed:', error);
            },
            datesSet: function () {
                updateURL();
            }
        });

        calendar.render();
    }

    async function loadCalendars() {
        try {
            const response = await fetch('/api/calendars', {
                credentials: 'include'
            });

            if (!response.ok) {
                log.error('Failed to fetch calendars:', response.status);
                return;
            }

            const calendars = await response.json();

            if (!calendars || calendars.length === 0) {
                log.debug('No calendars to load');
                return;
            }

            // Clear existing event sources
            eventSources.forEach(es => {
                if (es.source) {
                    es.source.remove();
                }
            });
            eventSources = [];

            // Load each calendar
            calendars.forEach(cal => {
                if (!cal || !cal.id) return;

                // Parse events from the pre-processed events field
                let events = [];
                try {
                    if (cal.events) {
                        events = typeof cal.events === 'string'
                            ? JSON.parse(cal.events)
                            : cal.events;
                    }
                } catch (error) {
                    log.error('Failed to parse events for calendar', cal.id, error);
                    events = [];
                }

                log.debug('Loading calendar:', cal.name, 'with', events.length, 'events');

                // Build FullCalendar events with authentication-based detail hiding
                const fullCalendarEvents = buildFullCalendarEvents(cal, events, isAuthenticated);

                const source = {
                    events: fullCalendarEvents,
                    color: cal.color
                };

                const eventSource = calendar.addEventSource(source);

                eventSources.push({
                    id: cal.id,
                    name: cal.name,
                    color: cal.color,
                    source: eventSource,
                    visible: !cal.hidden,
                    lastUpdate: new Date(),
                    status: 'fresh',
                    details: cal.details
                });
            });

        } catch (error) {
            log.error('Error loading calendars:', error);
        }
    }

    function buildFullCalendarEvents(calendar, events, isAuthenticated) {
        if (!events || events.length === 0) return [];

        return events.map(event => {
            const shouldHideDetails = !isAuthenticated && calendar.details;

            const fcEvent = {
                title: event.title,
                start: event.start,
                allDay: event.allDay || false,
                backgroundColor: calendar.color,
                borderColor: calendar.color,
                textColor: 'white',
                extendedProps: buildExtendedProps(event)
            };

            if (shouldHideDetails) {
                fcEvent.title = '';
                fcEvent.extendedProps.description = '';
                fcEvent.extendedProps.location = '';
            }

            if (event.end) {
                fcEvent.end = event.end;
            }

            if (event.url) {
                fcEvent.url = event.url;
            }

            return fcEvent;
        });
    }

    function buildExtendedProps(event) {
        const props = {
            description: event.description || '',
            location: event.location || '',
            uid: event.uid || '',
            duration: event.duration || '',
            status: event.status || '',
            transparency: event.transparency || '',
            sequence: event.sequence ? String(event.sequence) : '0'
        };

        // Add timestamp fields if they exist
        if (event.dtStamp) {
            props.dtStamp = event.dtStamp;
        }
        if (event.created) {
            props.created = event.created;
        }
        if (event.lastModified) {
            props.lastModified = event.lastModified;
        }

        // Add organizer information if it exists
        if (event.organizer) {
            if (event.organizer.name) {
                props.organizerName = event.organizer.name;
            }
            if (event.organizer.email) {
                props.organizerEmail = event.organizer.email;
            }
        }

        // Add attendee information if it exists
        if (event.attendees && Array.isArray(event.attendees) && event.attendees.length > 0) {
            const attendeeNames = [];
            const attendeeEmails = [];

            for (const attendee of event.attendees) {
                if (attendee.name) {
                    attendeeNames.push(attendee.name);
                }
                if (attendee.email) {
                    attendeeEmails.push(attendee.email);
                }
            }

            if (attendeeNames.length > 0) {
                props.attendeeNames = attendeeNames.join(', ');
            }
            if (attendeeEmails.length > 0) {
                props.attendeeEmails = attendeeEmails.join(', ');
            }
            props.attendeeCount = String(event.attendees.length);
        }

        return props;
    }

    function linkify(text) {
        if (!text) return text;

        const words = text.split(/(\s+)/);

        return words.map(word => {
            if (/^\s+$/.test(word)) return word;

            let potentialContact = word;
            let trailingPunctuation = '';

            const punctuationMatch = word.match(/^(.+?)([.,;:!?)\]}>]+)$/);
            if (punctuationMatch) {
                potentialContact = punctuationMatch[1];
                trailingPunctuation = punctuationMatch[2];
            }

            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (emailRegex.test(potentialContact)) {
                return `<a href="mailto:${potentialContact}">${potentialContact}</a>${trailingPunctuation}`;
            }

            const phoneRegex = /^(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
            const phoneMatch = potentialContact.match(phoneRegex);
            if (phoneMatch) {
                const cleanPhone = potentialContact.replace(/[^\d+]/g, '');
                return `<a href="tel:${cleanPhone}">${potentialContact}</a>${trailingPunctuation}`;
            }

            try {
                const url = new URL(potentialContact);
                if (url.protocol === 'http:' || url.protocol === 'https:') {
                    return `<a href="${url.href}" target="_blank" rel="noopener noreferrer">${potentialContact}</a>${trailingPunctuation}`;
                }
            } catch (e) { }

            return word;
        }).join('');
    }

    function openEventModal(event) {
        const modal = document.getElementById('eventModal');
        const overlay = document.getElementById('eventModalOverlay');
        const titleEl = document.getElementById('eventTitle');
        const detailsEl = document.getElementById('eventDetails');

        titleEl.textContent = event.title || 'Event Details';

        const formatDate = (date) => {
            if (!date) return 'N/A';
            return date.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: event.allDay ? undefined : '2-digit',
                minute: event.allDay ? undefined : '2-digit'
            });
        };

        let detailsHTML = '';

        if (event.allDay) {
            detailsHTML += `<div class="event-detail"><label>When:</label> All day event</div>`;
        }

        detailsHTML += `<div class="event-detail"><label>Start:</label> ${formatDate(event.start)}</div>`;

        if (event.end) {
            detailsHTML += `<div class="event-detail"><label>End:</label> ${formatDate(event.end)}</div>`;
        }

        if (event.start && event.end && !event.allDay) {
            const duration = (event.end - event.start) / 1000 / 60;
            if (duration < 60) {
                detailsHTML += `<div class="event-detail"><label>Duration:</label> ${duration} minutes</div>`;
            } else {
                const hours = Math.floor(duration / 60);
                const mins = duration % 60;
                detailsHTML += `<div class="event-detail"><label>Duration:</label> ${hours}h ${mins > 0 ? mins + 'm' : ''}</div>`;
            }
        }

        if (event.extendedProps && event.extendedProps.location) {
            const locationWithLinks = linkify(event.extendedProps.location);
            detailsHTML += `<div class="event-detail"><label>Location:</label> ${locationWithLinks}</div>`;
        }

        if (event.extendedProps && event.extendedProps.description) {
            const descriptionWithLinks = linkify(event.extendedProps.description);
            detailsHTML += `<div class="event-detail"><label>Description:</label><br>${descriptionWithLinks}</div>`;
        }

        // Show event status if available
        if (event.extendedProps && event.extendedProps.status) {
            detailsHTML += `<div class="event-detail"><label>Status:</label> ${event.extendedProps.status}</div>`;
        }

        // Show organizer information if available
        if (event.extendedProps && (event.extendedProps.organizerName || event.extendedProps.organizerEmail)) {
            let organizerInfo = '';
            if (event.extendedProps.organizerName) {
                organizerInfo += event.extendedProps.organizerName;
            }
            if (event.extendedProps.organizerEmail) {
                const emailLink = `<a href="mailto:${event.extendedProps.organizerEmail}">${event.extendedProps.organizerEmail}</a>`;
                organizerInfo += organizerInfo ? ` (${emailLink})` : emailLink;
            }
            detailsHTML += `<div class="event-detail"><label>Organizer:</label> ${organizerInfo}</div>`;
        }

        // Show attendee information if available
        if (event.extendedProps && event.extendedProps.attendeeCount && parseInt(event.extendedProps.attendeeCount) > 0) {
            detailsHTML += `<div class="event-detail"><label>Attendees:</label> ${event.extendedProps.attendeeCount} attendee(s)</div>`;

            if (event.extendedProps.attendeeNames) {
                detailsHTML += `<div class="event-detail"><label>Names:</label> ${event.extendedProps.attendeeNames}</div>`;
            }

            if (event.extendedProps.attendeeEmails) {
                const emailList = event.extendedProps.attendeeEmails.split(', ')
                    .map(email => `<a href="mailto:${email}">${email}</a>`)
                    .join(', ');
                detailsHTML += `<div class="event-detail"><label>Emails:</label> ${emailList}</div>`;
            }
        }

        // Show event duration from iCal if available
        if (event.extendedProps && event.extendedProps.duration) {
            detailsHTML += `<div class="event-detail"><label>Duration:</label> ${event.extendedProps.duration}</div>`;
        }

        // Show transparency if available
        if (event.extendedProps && event.extendedProps.transparency) {
            const transparencyText = event.extendedProps.transparency === 'OPAQUE' ? 'Busy' : 'Free';
            detailsHTML += `<div class="event-detail"><label>Show as:</label> ${transparencyText}</div>`;
        }

        // Show timestamps if available
        if (event.extendedProps && event.extendedProps.created) {
            const createdDate = new Date(event.extendedProps.created);
            detailsHTML += `<div class="event-detail"><label>Created:</label> ${createdDate.toLocaleString()}</div>`;
        }

        if (event.extendedProps && event.extendedProps.lastModified) {
            const modifiedDate = new Date(event.extendedProps.lastModified);
            detailsHTML += `<div class="event-detail"><label>Modified:</label> ${modifiedDate.toLocaleString()}</div>`;
        }

        // Show event UID for debugging/technical details
        if (event.extendedProps && event.extendedProps.uid) {
            detailsHTML += `<div class="event-detail"><label>Event ID:</label> <code style="font-size: 0.8em; background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">${event.extendedProps.uid}</code></div>`;
        }

        if (event.source) {
            const sourceCalendar = eventSources.find(es => es.source && es.source.url === event.source.url);
            if (sourceCalendar) {
                const calendarDisplayName = sourceCalendar.name || sourceCalendar.url;
                const displayText = sourceCalendar.name ? calendarDisplayName : linkify(calendarDisplayName);
                detailsHTML += `<div class="event-detail"><label>Calendar:</label> <span style="display:inline-block; width:12px; height:12px; background:${sourceCalendar.color}; border-radius:2px;"></span> ${displayText}</div>`;
            }
        }

        if (event.url) {
            detailsHTML += `<div class="event-detail"><label>Link:</label> <a href="${event.url}" target="_blank" rel="noopener noreferrer">Open in calendar</a></div>`;
        }

        detailsEl.innerHTML = detailsHTML;

        modal.classList.add('show');
        overlay.classList.add('show');

        overlay.onclick = closeEventModal;
    }

    function closeEventModal() {
        document.getElementById('eventModal').classList.remove('show');
        document.getElementById('eventModalOverlay').classList.remove('show');
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeEventModal();
        }
    });

    async function refetchAllCalendars() {
        if (!isAuthenticated) {
            showPasswordModal();
            return;
        }

        if (confirm('Are you sure you want to refetch all calendar data? This may take a moment.')) {
            try {
                const response = await fetch('/api/calendars/refetch', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    isAuthenticated = false;
                    showPasswordModal();
                    return;
                }

                if (response.ok) {
                    // Reload calendars after refetch
                    await loadCalendars();
                    alert('Calendars refetched successfully!');
                } else {
                    alert('Error refetching calendars');
                }
            } catch (error) {
                alert('Error refetching calendars: ' + error.message);
            }
        }
    }

    async function checkAuthStatus() {
        try {
            const response = await fetch('/api/auth/verify', {
                method: 'GET',
                credentials: 'include'
            });

            if (response.ok) {
                isAuthenticated = true;
                log.debug('User is authenticated');
            } else {
                isAuthenticated = false;
                log.debug('User is not authenticated');
            }
        } catch (error) {
            isAuthenticated = false;
            log.debug('Auth check failed:', error);
        }
    }

    async function init() {
        await checkAuthStatus();
        initCalendar();
        requestAnimationFrame(() => {
            loadCalendars();
        });
    }

    function updateURL() {
        const view = calendar.view;
        const date = calendar.getDate();
        const today = new Date().toISOString().split('T')[0];
        const currentDate = date.toISOString().split('T')[0];

        let viewName;
        switch (view.type) {
            case 'dayGridMonth':
                viewName = 'month';
                break;
            case 'timeGridWeek':
                viewName = 'week';
                break;
            case 'timeGridDay':
                viewName = 'day';
                break;
            case 'listMonth':
                viewName = 'list';
                break;
            default:
                viewName = 'week';
        }

        const url = new URL(window.location);
        url.searchParams.set('view', viewName);

        if (currentDate !== today) {
            url.searchParams.set('date', currentDate);
        } else {
            url.searchParams.delete('date');
        }

        window.history.replaceState({}, '', url.toString());
    }

    function showCalendarManagementModal() {
        if (!isAuthenticated) {
            showPasswordModal();
            return;
        }

        const modal = document.getElementById('calendarModal');
        const overlay = document.getElementById('calendarModalOverlay');

        loadCalendarList();

        modal.classList.add('show');
        overlay.classList.add('show');
    }

    function closeCalendarManagementModal() {
        document.getElementById('calendarModal').classList.remove('show');
        document.getElementById('calendarModalOverlay').classList.remove('show');
    }

    function showAddCalendarForm() {
        const modal = document.getElementById('addCalendarModal');
        const overlay = document.getElementById('addCalendarModalOverlay');

        // Clear form
        document.getElementById('calendar-name').value = '';
        document.getElementById('calendar-url').value = '';
        document.getElementById('calendar-color').value = '#3498db';

        modal.classList.add('show');
        overlay.classList.add('show');
    }

    function closeAddCalendarModal() {
        document.getElementById('addCalendarModal').classList.remove('show');
        document.getElementById('addCalendarModalOverlay').classList.remove('show');
    }

    async function loadCalendarList() {
        try {
            const response = await fetch('/api/calendars', {
                credentials: 'include'
            });

            if (response.status === 401) {
                isAuthenticated = false;
                showPasswordModal();
                return;
            }

            if (response.ok) {
                const calendars = await response.json();
                displayCalendarList(calendars);
            }
        } catch (error) {
            log.error('Error loading calendar list:', error);
        }
    }

    function displayCalendarList(calendars) {
        const listEl = document.getElementById('calendarList');

        if (!calendars || calendars.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; color: #666; margin: 20px 0;">No calendars found. Add your first calendar!</p>';
            return;
        }

        listEl.innerHTML = calendars.map(cal => {
            const isVisible = !cal.hidden; // Convert hidden to visible for display
            return `
            <div class="calendar-item" style="display: flex; align-items: center; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 4px;">
                <div style="width: 20px; height: 20px; background: ${cal.color}; border-radius: 3px; margin-right: 10px;"></div>
                <div style="flex: 1;">
                    <div style="font-weight: bold;">${cal.name}</div>
                    <div style="font-size: 0.9em; color: #666;">${cal.url}</div>
                    <div style="font-size: 0.8em; color: #888;">
                        ${isVisible ? 'Visible' : 'Hidden'} •
                        Last updated: ${cal.updated_at ? new Date(cal.updated_at).toLocaleDateString() : 'Never'}
                    </div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="deleteCalendar(${cal.id})"
                            style="padding: 5px 10px; border: 1px solid #dc3545; background: #dc3545; color: white; cursor: pointer; border-radius: 3px;">
                        Delete
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }

    async function addCalendar() {
        const name = document.getElementById('calendar-name').value.trim();
        const url = document.getElementById('calendar-url').value.trim();
        const color = document.getElementById('calendar-color').value;

        if (!name || !url) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/api/calendars', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, url, color })
            });

            if (response.status === 401) {
                isAuthenticated = false;
                showPasswordModal();
                return;
            }

            if (response.ok) {
                closeAddCalendarModal();
                await loadCalendarList();
                // Reload calendars in the main view
                await loadCalendars();
            } else {
                const error = await response.json();
                alert('Error adding calendar: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error adding calendar: ' + error.message);
        }
    }

    async function deleteCalendar(calendarId) {
        if (!confirm('Are you sure you want to delete this calendar? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/calendars/${calendarId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.status === 401) {
                isAuthenticated = false;
                showPasswordModal();
                return;
            }

            if (response.ok) {
                await loadCalendarList();
                // Reload calendars in the main view
                await loadCalendars();
            } else {
                alert('Error deleting calendar');
            }
        } catch (error) {
            alert('Error deleting calendar: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        init();
    });
</script>
