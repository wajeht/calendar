<div id="calendar"></div>

<%- include('../_components/password-modal.html') %>
<%- include('../_components/toast.html') %>
<%- include('../_components/confirm-modal.html') %>
<%- include('../_components/calendar-modals.html') %>
<%- include('../_components/event-modal.html') %>

<script>
    let calendar;
    let eventSources = [];
    let isAuthenticated = false;
    let sharedCalendarData = [];

    const viewMappings = {
        month: 'dayGridMonth',
        week: 'timeGridWeek',
        day: 'timeGridDay',
        list: 'listMonth'
    };

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');

        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        const dateParam = urlParams.get('date');

        const initialView = viewMappings[viewParam] || 'timeGridWeek';

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: initialView,
            initialDate: dateParam || undefined,
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth refetchButton settingsButton'
            },
            customButtons: {
                refetchButton: {
                    text: 'refetch',
                    hint: 'Refetch All Calendars',
                    click: function () {
                        refetchAllCalendars();
                    }
                },
                settingsButton: {
                    text: 'settings',
                    hint: 'Manage Calendars',
                    click: function () {
                        if (isAuthenticated) {
                            calendarModals.management.show();
                        } else {
                            passwordModal.show();
                        }
                    }
                },
                logoutButton: {
                    text: 'logout',
                    hint: 'Logout',
                    click: function () {
                        logout();
                    }
                }
            },
            height: '100%',
            nowIndicator: true,
            expandRows: true,
            editable: false,
            selectable: false,
            selectMirror: false,
            businessHours: {
                daysOfWeek: [1, 2, 3, 4, 5], // Monday - Friday
                startTime: '09:00',
                endTime: '17:00'
            },
            eventSources: [],
            eventClick: function (info) {
                info.jsEvent.preventDefault();

                if (info.event.extendedProps && info.event.extendedProps.isDetailHidden) {
                    return;
                }

                const sourceCalendar = eventSources.find(es => es.id == info.event.source.id);

                if (typeof eventModal !== 'undefined' && eventModal.show) {
                    eventModal.show(info.event, sourceCalendar);
                } else {
                    console.error('Event modal not available');
                }
            },
            loading: function (isLoading) {
                if (isLoading) {
                    log.debug('Loading calendar...');
                }
            },
            eventSourceFailure: function (error) {
                log.error('Calendar load failed:', error);
            },
            datesSet: function () {
                updateURL();
            }
        });

        calendar.render();
    }

    async function loadCalendars() {
        try {
            const response = await fetch('/api/calendars', { credentials: 'include' });

            if (!response.ok) {
                log.error('Failed to fetch calendars:', response.status);
                return;
            }

            const calendars = await response.json();
            sharedCalendarData = calendars;

            if (!calendars || calendars.length === 0) {
                log.debug('No calendars to load');
                return;
            }

            calendar.removeAllEventSources();
            eventSources = [];

            for (let i = 0; i < calendars.length; i++) {
                const cal = calendars[i];
                if (!cal || !cal.id) continue;

                const events = cal.events || [];

                log.debug('Loading calendar:', cal.name, 'with', events.length, 'events');

                const source = {
                    id: cal.id,
                    events: events,
                    color: cal.color
                };

                const eventSource = calendar.addEventSource(source);

                eventSources.push({
                    id: cal.id,
                    name: cal.name,
                    color: cal.color
                });
            }

        } catch (error) {
            log.error('Error loading calendars:', error);
        }
    }

    async function refetchAllCalendars() {
        if (!isAuthenticated) {
            passwordModal.show();
            return;
        }

        const confirmed = await confirmModal.warning(
            'Are you sure you want to refetch all calendar data? This may take a moment.',
            'Refetch All Calendars'
        );

        if (confirmed) {
            try {
                const response = await fetch('/api/calendars/refetch', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    isAuthenticated = false;
                    passwordModal.show();
                    return;
                }

                if (response.ok) {
                    await loadCalendars();
                    toast.success('Calendars refetched successfully!');
                } else {
                    toast.error('Error refetching calendars');
                }
            } catch (error) {
                toast.error('Error refetching calendars: ' + error.message);
            }
        }
    }

    async function logout() {
        try {
            const response = await fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });

            if (response.ok) {
                isAuthenticated = false;
                sharedCalendarData = []; // Clear shared data
                updateToolbar();
                await loadCalendars(); // Reload with public data
                toast.success('Logged out successfully');
            } else {
                toast.error('Error during logout');
            }
        } catch (error) {
            toast.error('Error during logout: ' + error.message);
        }
    }

    function updateToolbar() {
        if (calendar) {
            const rightButtons = isAuthenticated
                ? 'dayGridMonth,timeGridWeek,timeGridDay,listMonth refetchButton settingsButton logoutButton'
                : 'dayGridMonth,timeGridWeek,timeGridDay,listMonth settingsButton';

            calendar.setOption('headerToolbar', {
                left: 'prev,next today',
                center: 'title',
                right: rightButtons
            });
        }
    }

    async function checkAuthStatus() {
        try {
            const response = await fetch('/api/auth/verify', {
                method: 'GET',
                credentials: 'include'
            });

            if (response.ok) {
                isAuthenticated = true;
                log.debug('User is authenticated');
            } else {
                isAuthenticated = false;
                log.debug('User is not authenticated');
            }
            updateToolbar();
        } catch (error) {
            isAuthenticated = false;
            log.debug('Auth check failed:', error);
            updateToolbar();
        }
    }

    function waitForModalsToLoad() {
        return new Promise((resolve) => {
            const checkModals = () => {
                if (typeof eventModal !== 'undefined' &&
                    typeof calendarModals !== 'undefined' &&
                    typeof passwordModal !== 'undefined' &&
                    typeof toast !== 'undefined' &&
                    typeof confirmModal !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(checkModals, 10);
                }
            };
            checkModals();
        });
    }

    async function init() {
        await waitForModalsToLoad();
        await checkAuthStatus();
        initCalendar();
        updateToolbar();
        requestAnimationFrame(() => {
            loadCalendars();
        });
    }

    function updateURL() {
        const view = calendar.view;
        const date = calendar.getDate();
        const today = new Date().toISOString().split('T')[0];
        const currentDate = date.toISOString().split('T')[0];

        const viewName = Object.keys(viewMappings).find(key => viewMappings[key] === view.type) || 'week';

        const url = new URL(window.location);
        url.searchParams.set('view', viewName);

        if (currentDate !== today) {
            url.searchParams.set('date', currentDate);
        } else {
            url.searchParams.delete('date');
        }

        window.history.replaceState({}, '', url.toString());
    }

    document.addEventListener('DOMContentLoaded', () => init());
</script>
