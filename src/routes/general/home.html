<div id="calendar"></div>

<%- include('../_components/password-modal.html') %>

<style>
.calendar-list {
    margin-bottom: 20px;
}

.calendar-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border: 1px solid #ddd;
    margin-bottom: 8px;
    background: #fafafa;
    border-radius: 3px;
}

.calendar-item:hover {
    background: #f0f0f0;
}

.calendar-color {
    width: 16px;
    height: 16px;
    border: 1px solid #ccc;
    border-radius: 2px;
    margin-right: 12px;
    flex-shrink: 0;
}

.calendar-info {
    flex: 1;
    min-width: 0;
}

.calendar-name {
    font-weight: bold;
    font-size: 14px;
    color: #333;
    margin-bottom: 2px;
}

.calendar-url {
    font-size: 11px;
    color: #666;
    word-break: break-all;
    margin-bottom: 2px;
}

.calendar-meta {
    font-size: 11px;
    color: #999;
}

.calendar-actions {
    margin-left: 12px;
    flex-shrink: 0;
}

.no-calendars-message {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 40px 20px;
    border: 2px dashed #ddd;
    border-radius: 3px;
    background: #fafafa;
}
</style>

<!-- Calendar Management Modal -->
<div class="modal-overlay" id="calendarModalOverlay"></div>
<div class="modal" id="calendarModal">
    <div class="modal-header">
        <h2>Manage Calendars</h2>
        <button class="modal-close" onclick="closeCalendarManagementModal()">×</button>
    </div>
    <div class="modal-body">
        <div class="calendar-list" id="calendarList">
            <!-- Calendar list will be populated here -->
        </div>
    </div>
    <div class="modal-footer">
        <button onclick="showAddCalendarForm()" class="fc-button fc-button-primary">Add Calendar</button>
        <button onclick="closeCalendarManagementModal()" class="fc-button">Close</button>
    </div>
</div>

<!-- Add Calendar Form Modal -->
<div class="modal-overlay" id="addCalendarModalOverlay"></div>
<div class="modal" id="addCalendarModal">
    <div class="modal-header">
        <h2>Add New Calendar</h2>
        <button class="modal-close" onclick="backToCalendarManagement()">×</button>
    </div>
    <div class="modal-body">
        <div class="fc-form">
            <div class="fc-form-group">
                <label for="calendar-name">Name:</label>
                <input type="text" id="calendar-name" placeholder="Calendar name" required>
            </div>
            <div class="fc-form-group">
                <label for="calendar-url">URL:</label>
                <input type="url" id="calendar-url" placeholder="https://example.com/calendar.ics" required>
            </div>
            <div class="fc-form-group">
                <label for="calendar-color">Color:</label>
                <input type="color" id="calendar-color" value="#3498db">
            </div>
            <div class="fc-form-group">
                <table class="fc-checkbox-table">
                    <tr>
                        <td class="fc-checkbox-cell">
                            <input type="checkbox" id="calendar-hidden">
                        </td>
                        <td class="fc-label-cell">
                            <label for="calendar-hidden">Hide calendar from public view</label>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="fc-form-group">
                <table class="fc-checkbox-table">
                    <tr>
                        <td class="fc-checkbox-cell">
                            <input type="checkbox" id="calendar-hide-details">
                        </td>
                        <td class="fc-label-cell">
                            <label for="calendar-hide-details">Hide event details for public view (show as time blocks only)</label>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button onclick="addCalendar()" class="fc-button fc-button-primary">Add Calendar</button>
        <button onclick="backToCalendarManagement()" class="fc-button">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="eventModalOverlay"></div>
<div class="modal" id="eventModal" style="max-width: 500px;">
    <div class="modal-header">
        <h2 id="eventTitle">Event Details</h2>
        <button class="modal-close" onclick="closeEventModal()">×</button>
    </div>
    <div class="modal-body">
        <div id="eventDetails"></div>
    </div>
</div>

<script>
    let calendar;
    let eventSources = [];
    let isAuthenticated = false;

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');

        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        const dateParam = urlParams.get('date');

        let initialView = 'timeGridWeek';
        if (viewParam) {
            switch (viewParam) {
                case 'month':
                    initialView = 'dayGridMonth';
                    break;
                case 'week':
                    initialView = 'timeGridWeek';
                    break;
                case 'day':
                    initialView = 'timeGridDay';
                    break;
                case 'list':
                    initialView = 'listMonth';
                    break;
            }
        }

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: initialView,
            initialDate: dateParam || undefined,
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth refetchButton settingsButton'
            },
            customButtons: {
                refetchButton: {
                    text: 'refetch',
                    hint: 'Refetch All Calendars',
                    click: function () {
                        refetchAllCalendars();
                    }
                },
                settingsButton: {
                    text: 'settings',
                    hint: 'Manage Calendars',
                    click: function () {
                        if (isAuthenticated) {
                            showCalendarManagementModal();
                        } else {
                            showPasswordModal();
                        }
                    }
                }
            },
            height: '100%',
            nowIndicator: true,
            expandRows: true,
            editable: false,
            selectable: false,
            selectMirror: false,
            businessHours: {
                daysOfWeek: [1, 2, 3, 4, 5], // Monday - Friday
                startTime: '09:00',
                endTime: '17:00'
            },
            eventSources: [],
            eventClick: function (info) {
                info.jsEvent.preventDefault();

                const eventSourceUrl = info.event.source?.url || info.event.source?.internalEventSource?.meta?.url;
                log.debug('Event source URL:', eventSourceUrl, 'Event color:', info.event.backgroundColor);

                const sourceCalendar = eventSources.find(es => {
                    return es.color === info.event.backgroundColor ||
                        (es.source && es.source.url === eventSourceUrl);
                });

                log.debug('Found calendar:', sourceCalendar, 'Auth:', isAuthenticated);

                if (!isAuthenticated && sourceCalendar && sourceCalendar.details) {
                    log.public('Details hidden for public view');
                    return;
                }

                openEventModal(info.event);
            },
            loading: function (isLoading) {
                if (isLoading) {
                    log.debug('Loading calendar...');
                }
            },
            eventSourceFailure: function (error) {
                log.error('Calendar load failed:', error);
            },
            datesSet: function () {
                updateURL();
            }
        });

        calendar.render();
    }

    async function loadCalendars() {
        try {
            const response = await fetch('/api/calendars', {
                credentials: 'include'
            });

            if (!response.ok) {
                log.error('Failed to fetch calendars:', response.status);
                return;
            }

            const calendars = await response.json();

            if (!calendars || calendars.length === 0) {
                log.debug('No calendars to load');
                return;
            }

            // Clear existing event sources
            eventSources.forEach(es => {
                if (es.source) {
                    es.source.remove();
                }
            });
            eventSources = [];

            // Load each calendar
            calendars.forEach(cal => {
                if (!cal || !cal.id) return;

                // Parse events from the pre-processed events field
                let events = [];
                try {
                    if (cal.events) {
                        events = typeof cal.events === 'string'
                            ? JSON.parse(cal.events)
                            : cal.events;
                    }
                } catch (error) {
                    log.error('Failed to parse events for calendar', cal.id, error);
                    events = [];
                }

                log.debug('Loading calendar:', cal.name, 'with', events.length, 'events');

                // Log sample of events for debugging
                if (events.length > 0) {
                    log.debug('Sample events:', events.slice(0, 3).map(e => ({
                        title: e.title,
                        start: e.start,
                        end: e.end,
                        uid: e.uid
                    })));
                }

                // Build FullCalendar events with authentication-based detail hiding
                const fullCalendarEvents = buildFullCalendarEvents(cal, events, isAuthenticated);

                log.debug('Built', fullCalendarEvents.length, 'FullCalendar events for calendar:', cal.name);

                const source = {
                    events: fullCalendarEvents,
                    color: cal.color
                };

                const eventSource = calendar.addEventSource(source);

                eventSources.push({
                    id: cal.id,
                    name: cal.name,
                    color: cal.color,
                    source: eventSource,
                    visible: !cal.hidden,
                    lastUpdate: new Date(),
                    status: 'fresh',
                    details: cal.details
                });
            });

        } catch (error) {
            log.error('Error loading calendars:', error);
        }
    }

    function buildFullCalendarEvents(calendar, events, isAuthenticated) {
        if (!events || events.length === 0) return [];

        const validEvents = [];
        const skippedEvents = [];

        events.forEach(event => {
            // Skip events without valid start date or title
            if (!event.start && !event.title) {
                skippedEvents.push({ reason: 'No start date or title', event: event.uid || 'unknown' });
                return;
            }

            const shouldHideDetails = !isAuthenticated && calendar.details;

            const fcEvent = {
                title: event.title || 'Untitled Event',
                start: event.start,
                allDay: event.allDay || false,
                backgroundColor: calendar.color,
                borderColor: calendar.color,
                textColor: 'white',
                extendedProps: buildExtendedProps(event)
            };

            if (shouldHideDetails) {
                fcEvent.title = '';
                fcEvent.extendedProps.description = '';
                fcEvent.extendedProps.location = '';
            }

            if (event.end) {
                fcEvent.end = event.end;
            }

            if (event.url) {
                fcEvent.url = event.url;
            }

            validEvents.push(fcEvent);
        });

        if (skippedEvents.length > 0) {
            log.debug('Skipped', skippedEvents.length, 'invalid events:', skippedEvents);
        }

        return validEvents;
    }

    function buildExtendedProps(event) {
        const props = {
            description: event.description || '',
            location: event.location || '',
            uid: event.uid || '',
            duration: event.duration || '',
            status: event.status || '',
            transparency: event.transparency || '',
            sequence: event.sequence ? String(event.sequence) : '0'
        };

        // Add timestamp fields if they exist
        if (event.dtStamp) {
            props.dtStamp = event.dtStamp;
        }
        if (event.created) {
            props.created = event.created;
        }
        if (event.lastModified) {
            props.lastModified = event.lastModified;
        }

        // Add organizer information if it exists
        if (event.organizer) {
            if (event.organizer.name) {
                props.organizerName = event.organizer.name;
            }
            if (event.organizer.email) {
                props.organizerEmail = event.organizer.email;
            }
        }

        // Add attendee information if it exists
        if (event.attendees && Array.isArray(event.attendees) && event.attendees.length > 0) {
            const attendeeNames = [];
            const attendeeEmails = [];

            for (const attendee of event.attendees) {
                if (attendee.name) {
                    attendeeNames.push(attendee.name);
                }
                if (attendee.email) {
                    attendeeEmails.push(attendee.email);
                }
            }

            if (attendeeNames.length > 0) {
                props.attendeeNames = attendeeNames.join(', ');
            }
            if (attendeeEmails.length > 0) {
                props.attendeeEmails = attendeeEmails.join(', ');
            }
            props.attendeeCount = String(event.attendees.length);
        }

        return props;
    }

    function linkify(text) {
        if (!text) return text;

        const words = text.split(/(\s+)/);

        return words.map(word => {
            if (/^\s+$/.test(word)) return word;

            let potentialContact = word;
            let trailingPunctuation = '';

            const punctuationMatch = word.match(/^(.+?)([.,;:!?)\]}>]+)$/);
            if (punctuationMatch) {
                potentialContact = punctuationMatch[1];
                trailingPunctuation = punctuationMatch[2];
            }

            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (emailRegex.test(potentialContact)) {
                return `<a href="mailto:${potentialContact}">${potentialContact}</a>${trailingPunctuation}`;
            }

            const phoneRegex = /^(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
            const phoneMatch = potentialContact.match(phoneRegex);
            if (phoneMatch) {
                const cleanPhone = potentialContact.replace(/[^\d+]/g, '');
                return `<a href="tel:${cleanPhone}">${potentialContact}</a>${trailingPunctuation}`;
            }

            try {
                const url = new URL(potentialContact);
                if (url.protocol === 'http:' || url.protocol === 'https:') {
                    return `<a href="${url.href}" target="_blank" rel="noopener noreferrer">${potentialContact}</a>${trailingPunctuation}`;
                }
            } catch (e) { }

            return word;
        }).join('');
    }

    function openEventModal(event) {
        const modal = document.getElementById('eventModal');
        const overlay = document.getElementById('eventModalOverlay');
        const titleEl = document.getElementById('eventTitle');
        const detailsEl = document.getElementById('eventDetails');

        titleEl.textContent = event.title || 'Event Details';

        const formatDate = (date) => {
            if (!date) return 'N/A';
            return date.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: event.allDay ? undefined : '2-digit',
                minute: event.allDay ? undefined : '2-digit'
            });
        };

        let detailsHTML = '';

        if (event.allDay) {
            detailsHTML += `<div class="event-detail"><label>When:</label> All day event</div>`;
        }

        detailsHTML += `<div class="event-detail"><label>Start:</label> ${formatDate(event.start)}</div>`;

        if (event.end) {
            detailsHTML += `<div class="event-detail"><label>End:</label> ${formatDate(event.end)}</div>`;
        }

        if (event.start && event.end && !event.allDay) {
            const duration = (event.end - event.start) / 1000 / 60;
            if (duration < 60) {
                detailsHTML += `<div class="event-detail"><label>Duration:</label> ${duration} minutes</div>`;
            } else {
                const hours = Math.floor(duration / 60);
                const mins = duration % 60;
                detailsHTML += `<div class="event-detail"><label>Duration:</label> ${hours}h ${mins > 0 ? mins + 'm' : ''}</div>`;
            }
        }

        if (event.extendedProps && event.extendedProps.location) {
            const locationWithLinks = linkify(event.extendedProps.location);
            detailsHTML += `<div class="event-detail"><label>Location:</label> ${locationWithLinks}</div>`;
        }

        if (event.extendedProps && event.extendedProps.description) {
            const descriptionWithLinks = linkify(event.extendedProps.description);
            detailsHTML += `<div class="event-detail"><label>Description:</label><br>${descriptionWithLinks}</div>`;
        }

        // Show event status if available
        if (event.extendedProps && event.extendedProps.status) {
            detailsHTML += `<div class="event-detail"><label>Status:</label> ${event.extendedProps.status}</div>`;
        }

        // Show organizer information if available
        if (event.extendedProps && (event.extendedProps.organizerName || event.extendedProps.organizerEmail)) {
            let organizerInfo = '';
            if (event.extendedProps.organizerName) {
                organizerInfo += event.extendedProps.organizerName;
            }
            if (event.extendedProps.organizerEmail) {
                const emailLink = `<a href="mailto:${event.extendedProps.organizerEmail}">${event.extendedProps.organizerEmail}</a>`;
                organizerInfo += organizerInfo ? ` (${emailLink})` : emailLink;
            }
            detailsHTML += `<div class="event-detail"><label>Organizer:</label> ${organizerInfo}</div>`;
        }

        // Show attendee information if available
        if (event.extendedProps && event.extendedProps.attendeeCount && parseInt(event.extendedProps.attendeeCount) > 0) {
            detailsHTML += `<div class="event-detail"><label>Attendees:</label> ${event.extendedProps.attendeeCount} attendee(s)</div>`;

            if (event.extendedProps.attendeeNames) {
                detailsHTML += `<div class="event-detail"><label>Names:</label> ${event.extendedProps.attendeeNames}</div>`;
            }

            if (event.extendedProps.attendeeEmails) {
                const emailList = event.extendedProps.attendeeEmails.split(', ')
                    .map(email => `<a href="mailto:${email}">${email}</a>`)
                    .join(', ');
                detailsHTML += `<div class="event-detail"><label>Emails:</label> ${emailList}</div>`;
            }
        }

        // Show event duration from iCal if available
        if (event.extendedProps && event.extendedProps.duration) {
            detailsHTML += `<div class="event-detail"><label>Duration:</label> ${event.extendedProps.duration}</div>`;
        }

        // Show transparency if available
        if (event.extendedProps && event.extendedProps.transparency) {
            const transparencyText = event.extendedProps.transparency === 'OPAQUE' ? 'Busy' : 'Free';
            detailsHTML += `<div class="event-detail"><label>Show as:</label> ${transparencyText}</div>`;
        }

        // Show timestamps if available
        if (event.extendedProps && event.extendedProps.created) {
            const createdDate = new Date(event.extendedProps.created);
            detailsHTML += `<div class="event-detail"><label>Created:</label> ${createdDate.toLocaleString()}</div>`;
        }

        if (event.extendedProps && event.extendedProps.lastModified) {
            const modifiedDate = new Date(event.extendedProps.lastModified);
            detailsHTML += `<div class="event-detail"><label>Modified:</label> ${modifiedDate.toLocaleString()}</div>`;
        }

        // Show event UID for debugging/technical details
        if (event.extendedProps && event.extendedProps.uid) {
            detailsHTML += `<div class="event-detail"><label>Event ID:</label> <code style="font-size: 0.8em; background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">${event.extendedProps.uid}</code></div>`;
        }

        if (event.source) {
            const sourceCalendar = eventSources.find(es => es.source && es.source.url === event.source.url);
            if (sourceCalendar) {
                const calendarDisplayName = sourceCalendar.name || sourceCalendar.url;
                const displayText = sourceCalendar.name ? calendarDisplayName : linkify(calendarDisplayName);
                detailsHTML += `<div class="event-detail"><label>Calendar:</label> <span style="display:inline-block; width:12px; height:12px; background:${sourceCalendar.color}; border-radius:2px;"></span> ${displayText}</div>`;
            }
        }

        if (event.url) {
            detailsHTML += `<div class="event-detail"><label>Link:</label> <a href="${event.url}" target="_blank" rel="noopener noreferrer">Open in calendar</a></div>`;
        }

        detailsEl.innerHTML = detailsHTML;

        modal.classList.add('show');
        overlay.classList.add('show');

        overlay.onclick = closeEventModal;
    }

    function closeEventModal() {
        document.getElementById('eventModal').classList.remove('show');
        document.getElementById('eventModalOverlay').classList.remove('show');
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeEventModal();
        }
    });

    async function refetchAllCalendars() {
        if (!isAuthenticated) {
            showPasswordModal();
            return;
        }

        if (confirm('Are you sure you want to refetch all calendar data? This may take a moment.')) {
            try {
                const response = await fetch('/api/calendars/refetch', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    isAuthenticated = false;
                    showPasswordModal();
                    return;
                }

                if (response.ok) {
                    // Reload calendars after refetch
                    await loadCalendars();
                    alert('Calendars refetched successfully!');
                } else {
                    alert('Error refetching calendars');
                }
            } catch (error) {
                alert('Error refetching calendars: ' + error.message);
            }
        }
    }

    async function checkAuthStatus() {
        try {
            const response = await fetch('/api/auth/verify', {
                method: 'GET',
                credentials: 'include'
            });

            if (response.ok) {
                isAuthenticated = true;
                log.debug('User is authenticated');
            } else {
                isAuthenticated = false;
                log.debug('User is not authenticated');
            }
        } catch (error) {
            isAuthenticated = false;
            log.debug('Auth check failed:', error);
        }
    }

    async function init() {
        await checkAuthStatus();
        initCalendar();
        requestAnimationFrame(() => {
            loadCalendars();
        });
    }

    function updateURL() {
        const view = calendar.view;
        const date = calendar.getDate();
        const today = new Date().toISOString().split('T')[0];
        const currentDate = date.toISOString().split('T')[0];

        let viewName;
        switch (view.type) {
            case 'dayGridMonth':
                viewName = 'month';
                break;
            case 'timeGridWeek':
                viewName = 'week';
                break;
            case 'timeGridDay':
                viewName = 'day';
                break;
            case 'listMonth':
                viewName = 'list';
                break;
            default:
                viewName = 'week';
        }

        const url = new URL(window.location);
        url.searchParams.set('view', viewName);

        if (currentDate !== today) {
            url.searchParams.set('date', currentDate);
        } else {
            url.searchParams.delete('date');
        }

        window.history.replaceState({}, '', url.toString());
    }

    function showCalendarManagementModal() {
        if (!isAuthenticated) {
            showPasswordModal();
            return;
        }

        const modal = document.getElementById('calendarModal');
        const overlay = document.getElementById('calendarModalOverlay');

        loadCalendarList();

        modal.classList.add('show');
        overlay.classList.add('show');
    }

    function closeCalendarManagementModal() {
        document.getElementById('calendarModal').classList.remove('show');
        document.getElementById('calendarModalOverlay').classList.remove('show');
    }

    function showAddCalendarForm() {
        // Close the calendar management modal first
        closeCalendarManagementModal();

        const modal = document.getElementById('addCalendarModal');
        const overlay = document.getElementById('addCalendarModalOverlay');

        // Clear form
        document.getElementById('calendar-name').value = '';
        document.getElementById('calendar-url').value = '';
        document.getElementById('calendar-color').value = '#3498db';
        document.getElementById('calendar-hidden').checked = false;
        document.getElementById('calendar-hide-details').checked = false;

        modal.classList.add('show');
        overlay.classList.add('show');
    }

    function closeAddCalendarModal() {
        document.getElementById('addCalendarModal').classList.remove('show');
        document.getElementById('addCalendarModalOverlay').classList.remove('show');
    }

    function backToCalendarManagement() {
        closeAddCalendarModal();
        showCalendarManagementModal();
    }

    async function loadCalendarList() {
        try {
            const response = await fetch('/api/calendars', {
                credentials: 'include'
            });

            if (response.status === 401) {
                isAuthenticated = false;
                showPasswordModal();
                return;
            }

            if (response.ok) {
                const calendars = await response.json();
                displayCalendarList(calendars);
            }
        } catch (error) {
            log.error('Error loading calendar list:', error);
        }
    }

    function displayCalendarList(calendars) {
        const listEl = document.getElementById('calendarList');

        if (!calendars || calendars.length === 0) {
            listEl.innerHTML = '<div class="no-calendars-message">No calendars found. Add your first calendar!</div>';
            return;
        }

        listEl.innerHTML = calendars.map(cal => {
            const isVisible = !cal.hidden;
            const showDetails = !cal.details;
            const statusParts = [];

            if (isVisible) {
                statusParts.push('Visible');
            } else {
                statusParts.push('Hidden');
            }

            if (!showDetails) {
                statusParts.push('Details hidden');
            }

            return `
            <div class="calendar-item">
                <div class="calendar-color" style="background: ${cal.color};"></div>
                <div class="calendar-info">
                    <div class="calendar-name">${cal.name}</div>
                    <div class="calendar-url">${cal.url}</div>
                    <div class="calendar-meta">
                        ${statusParts.join(' • ')} •
                        Last updated: ${cal.updated_at ? new Date(cal.updated_at).toLocaleDateString() : 'Never'}
                    </div>
                </div>
                <div class="calendar-actions">
                    <button onclick="deleteCalendar(${cal.id})" class="fc-button fc-button-danger">
                        Delete
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }

    async function addCalendar() {
        const name = document.getElementById('calendar-name').value.trim();
        const url = document.getElementById('calendar-url').value.trim();
        const color = document.getElementById('calendar-color').value;
        const hidden = document.getElementById('calendar-hidden').checked;
        const hideDetails = document.getElementById('calendar-hide-details').checked;

        if (!name || !url) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/api/calendars', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name,
                    url,
                    color,
                    hidden,
                    details: hideDetails
                })
            });

            if (response.status === 401) {
                isAuthenticated = false;
                showPasswordModal();
                return;
            }

            if (response.ok) {
                // Go back to calendar management modal and refresh the list
                backToCalendarManagement();
                await loadCalendarList();
                // Reload calendars in the main view
                await loadCalendars();
            } else {
                const error = await response.json();
                alert('Error adding calendar: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error adding calendar: ' + error.message);
        }
    }

    async function deleteCalendar(calendarId) {
        if (!confirm('Are you sure you want to delete this calendar? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/calendars/${calendarId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.status === 401) {
                isAuthenticated = false;
                showPasswordModal();
                return;
            }

            if (response.ok) {
                await loadCalendarList();
                // Reload calendars in the main view
                await loadCalendars();
            } else {
                alert('Error deleting calendar');
            }
        } catch (error) {
            alert('Error deleting calendar: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        init();
    });
</script>
