<div id="calendar"></div>

<%- include('../_components/password-modal.html') %>

<div class="event-modal-overlay" id="eventModalOverlay"></div>
<div class="event-modal" id="eventModal">
    <button class="event-modal-close" onclick="closeEventModal()">x</button>
    <h2 id="eventTitle">Event Details</h2>
    <div id="eventDetails"></div>
</div>

<script>
    let calendar;
    let eventSources = [];
    let isAuthenticated = true;

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');

        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        const dateParam = urlParams.get('date');

        let initialView = 'timeGridWeek';
        if (viewParam) {
            switch (viewParam) {
                case 'month':
                    initialView = 'dayGridMonth';
                    break;
                case 'week':
                    initialView = 'timeGridWeek';
                    break;
                case 'day':
                    initialView = 'timeGridDay';
                    break;
                case 'list':
                    initialView = 'listMonth';
                    break;
            }
        }

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: initialView,
            initialDate: dateParam || undefined,
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth refetchButton settingsButton'
            },
            customButtons: {
                refetchButton: {
                    text: 'refetch',
                    hint: 'Refetch All Calendars',
                    click: function () {
                        refetchAllCalendars();
                    }
                },
                settingsButton: {
                    text: 'settings',
                    hint: 'Manage Calendars',
                    click: function () {
                        window.location.href = '/calendars';
                    }
                }
            },
            height: '100%',
            nowIndicator: true,
            expandRows: true,
            editable: false,
            selectable: false,
            selectMirror: false,
            businessHours: {
                daysOfWeek: [1, 2, 3, 4, 5], // Monday - Friday
                startTime: '09:00',
                endTime: '17:00'
            },
            eventSources: [],
            eventClick: function (info) {
                info.jsEvent.preventDefault();

                const eventSourceUrl = info.event.source?.url || info.event.source?.internalEventSource?.meta?.url;
                log.debug('Event source URL:', eventSourceUrl, 'Event color:', info.event.backgroundColor);

                const sourceCalendar = eventSources.find(es => {
                    return es.color === info.event.backgroundColor ||
                        (es.source && es.source.url === eventSourceUrl);
                });

                log.debug('Found calendar:', sourceCalendar, 'Auth:', isAuthenticated);

                if (!isAuthenticated && sourceCalendar && sourceCalendar.details) {
                    log.public('Details hidden for public view');
                    return;
                }

                openEventModal(info.event);
            },
            loading: function (isLoading) {
                if (isLoading) {
                    log.debug('Loading calendar...');
                }
            },
            eventSourceFailure: function (error) {
                log.error('Calendar load failed:', error);
            },
            datesSet: function () {
                updateURL();
            }
        });

        calendar.render();
    }

    function loadCalendars() {
        const calendars = JSON.parse(`{{.Calendars}}`);

        calendars.forEach(cal => {
            if (!cal || !cal.id) return;

            log.debug('Loading calendar:', cal.name, 'with', cal.events.length, 'events');

            const source = {
                events: cal.events,
                color: cal.color
            };

            const eventSource = calendar.addEventSource(source);

            eventSources.push({
                id: cal.id,
                name: cal.name,
                color: cal.color,
                source: eventSource,
                visible: true,
                lastUpdate: new Date(),
                status: 'fresh'
            });
        });
    }

    function linkify(text) {
        if (!text) return text;

        const words = text.split(/(\s+)/);

        return words.map(word => {
            if (/^\s+$/.test(word)) return word;

            let potentialContact = word;
            let trailingPunctuation = '';

            const punctuationMatch = word.match(/^(.+?)([.,;:!?)\]}>]+)$/);
            if (punctuationMatch) {
                potentialContact = punctuationMatch[1];
                trailingPunctuation = punctuationMatch[2];
            }

            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (emailRegex.test(potentialContact)) {
                return `<a href="mailto:${potentialContact}">${potentialContact}</a>${trailingPunctuation}`;
            }

            const phoneRegex = /^(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
            const phoneMatch = potentialContact.match(phoneRegex);
            if (phoneMatch) {
                const cleanPhone = potentialContact.replace(/[^\d+]/g, '');
                return `<a href="tel:${cleanPhone}">${potentialContact}</a>${trailingPunctuation}`;
            }

            try {
                const url = new URL(potentialContact);
                if (url.protocol === 'http:' || url.protocol === 'https:') {
                    return `<a href="${url.href}" target="_blank" rel="noopener noreferrer">${potentialContact}</a>${trailingPunctuation}`;
                }
            } catch (e) { }

            return word;
        }).join('');
    }

    function openEventModal(event) {
        const modal = document.getElementById('eventModal');
        const overlay = document.getElementById('eventModalOverlay');
        const titleEl = document.getElementById('eventTitle');
        const detailsEl = document.getElementById('eventDetails');

        titleEl.textContent = event.title || 'Event Details';

        const formatDate = (date) => {
            if (!date) return 'N/A';
            return date.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: event.allDay ? undefined : '2-digit',
                minute: event.allDay ? undefined : '2-digit'
            });
        };

        let detailsHTML = '';

        if (event.allDay) {
            detailsHTML += `<div class="event-detail"><label>When:</label> All day event</div>`;
        }

        detailsHTML += `<div class="event-detail"><label>Start:</label> ${formatDate(event.start)}</div>`;

        if (event.end) {
            detailsHTML += `<div class="event-detail"><label>End:</label> ${formatDate(event.end)}</div>`;
        }

        if (event.start && event.end && !event.allDay) {
            const duration = (event.end - event.start) / 1000 / 60;
            if (duration < 60) {
                detailsHTML += `<div class="event-detail"><label>Duration:</label> ${duration} minutes</div>`;
            } else {
                const hours = Math.floor(duration / 60);
                const mins = duration % 60;
                detailsHTML += `<div class="event-detail"><label>Duration:</label> ${hours}h ${mins > 0 ? mins + 'm' : ''}</div>`;
            }
        }

        if (event.extendedProps && event.extendedProps.location) {
            const locationWithLinks = linkify(event.extendedProps.location);
            detailsHTML += `<div class="event-detail"><label>Location:</label> ${locationWithLinks}</div>`;
        }

        if (event.extendedProps && event.extendedProps.description) {
            const descriptionWithLinks = linkify(event.extendedProps.description);
            detailsHTML += `<div class="event-detail"><label>Description:</label><br>${descriptionWithLinks}</div>`;
        }

        // Show event status if available
        if (event.extendedProps && event.extendedProps.status) {
            detailsHTML += `<div class="event-detail"><label>Status:</label> ${event.extendedProps.status}</div>`;
        }

        // Show organizer information if available
        if (event.extendedProps && (event.extendedProps.organizerName || event.extendedProps.organizerEmail)) {
            let organizerInfo = '';
            if (event.extendedProps.organizerName) {
                organizerInfo += event.extendedProps.organizerName;
            }
            if (event.extendedProps.organizerEmail) {
                const emailLink = `<a href="mailto:${event.extendedProps.organizerEmail}">${event.extendedProps.organizerEmail}</a>`;
                organizerInfo += organizerInfo ? ` (${emailLink})` : emailLink;
            }
            detailsHTML += `<div class="event-detail"><label>Organizer:</label> ${organizerInfo}</div>`;
        }

        // Show attendee information if available
        if (event.extendedProps && event.extendedProps.attendeeCount && parseInt(event.extendedProps.attendeeCount) > 0) {
            detailsHTML += `<div class="event-detail"><label>Attendees:</label> ${event.extendedProps.attendeeCount} attendee(s)</div>`;

            if (event.extendedProps.attendeeNames) {
                detailsHTML += `<div class="event-detail"><label>Names:</label> ${event.extendedProps.attendeeNames}</div>`;
            }

            if (event.extendedProps.attendeeEmails) {
                const emailList = event.extendedProps.attendeeEmails.split(', ')
                    .map(email => `<a href="mailto:${email}">${email}</a>`)
                    .join(', ');
                detailsHTML += `<div class="event-detail"><label>Emails:</label> ${emailList}</div>`;
            }
        }

        // Show event duration from iCal if available
        if (event.extendedProps && event.extendedProps.duration) {
            detailsHTML += `<div class="event-detail"><label>Duration:</label> ${event.extendedProps.duration}</div>`;
        }

        // Show transparency if available
        if (event.extendedProps && event.extendedProps.transparency) {
            const transparencyText = event.extendedProps.transparency === 'OPAQUE' ? 'Busy' : 'Free';
            detailsHTML += `<div class="event-detail"><label>Show as:</label> ${transparencyText}</div>`;
        }

        // Show timestamps if available
        if (event.extendedProps && event.extendedProps.created) {
            const createdDate = new Date(event.extendedProps.created);
            detailsHTML += `<div class="event-detail"><label>Created:</label> ${createdDate.toLocaleString()}</div>`;
        }

        if (event.extendedProps && event.extendedProps.lastModified) {
            const modifiedDate = new Date(event.extendedProps.lastModified);
            detailsHTML += `<div class="event-detail"><label>Modified:</label> ${modifiedDate.toLocaleString()}</div>`;
        }

        // Show event UID for debugging/technical details
        if (event.extendedProps && event.extendedProps.uid) {
            detailsHTML += `<div class="event-detail"><label>Event ID:</label> <code style="font-size: 0.8em; background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">${event.extendedProps.uid}</code></div>`;
        }

        if (event.source) {
            const sourceCalendar = eventSources.find(es => es.source && es.source.url === event.source.url);
            if (sourceCalendar) {
                const calendarDisplayName = sourceCalendar.name || sourceCalendar.url;
                const displayText = sourceCalendar.name ? calendarDisplayName : linkify(calendarDisplayName);
                detailsHTML += `<div class="event-detail"><label>Calendar:</label> <span style="display:inline-block; width:12px; height:12px; background:${sourceCalendar.color}; border-radius:2px;"></span> ${displayText}</div>`;
            }
        }

        if (event.url) {
            detailsHTML += `<div class="event-detail"><label>Link:</label> <a href="${event.url}" target="_blank" rel="noopener noreferrer">Open in calendar</a></div>`;
        }

        detailsEl.innerHTML = detailsHTML;

        modal.classList.add('show');
        overlay.classList.add('show');

        overlay.onclick = closeEventModal;
    }

    function closeEventModal() {
        document.getElementById('eventModal').classList.remove('show');
        document.getElementById('eventModalOverlay').classList.remove('show');
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeEventModal();
        }
    });

    function refetchAllCalendars() {
        if (confirm('Are you sure you want to refetch all calendar data? This may take a moment.')) {
            fetch('/calendars/refetch', {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error refetching calendars');
                    }
                })
                .catch(error => {
                    alert('Error refetching calendars');
                });
        }
    }

    function init() {
        initCalendar();
        requestAnimationFrame(() => {
            loadCalendars();
        });
    }

    function updateURL() {
        const view = calendar.view;
        const date = calendar.getDate();
        const today = new Date().toISOString().split('T')[0];
        const currentDate = date.toISOString().split('T')[0];

        let viewName;
        switch (view.type) {
            case 'dayGridMonth':
                viewName = 'month';
                break;
            case 'timeGridWeek':
                viewName = 'week';
                break;
            case 'timeGridDay':
                viewName = 'day';
                break;
            case 'listMonth':
                viewName = 'list';
                break;
            default:
                viewName = 'week';
        }

        const url = new URL(window.location);
        url.searchParams.set('view', viewName);

        if (currentDate !== today) {
            url.searchParams.set('date', currentDate);
        } else {
            url.searchParams.delete('date');
        }

        window.history.replaceState({}, '', url.toString());
    }

    document.addEventListener('DOMContentLoaded', () => {
        init();
    });
</script>
