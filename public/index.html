<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.19/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.19/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.19/main.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        .controls {
            padding: 10px 15px;
            background: #f5f5f5;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls.show {
            display: block;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group input {
            width: 60%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .control-group button {
            padding: 6px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .control-group button:hover {
            background: #45a049;
        }
        .control-group button.remove {
            background: #f44336;
        }
        .control-group button.remove:hover {
            background: #da190b;
        }
        #calendar {
            height: 100vh;
            width: 100vw;
        }
        .calendar-item {
            padding: 6px;
            margin: 3px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .calendar-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .calendar-item span {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .info-message {
            padding: 8px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .error-message {
            padding: 8px;
            background: #ffebee;
            border-left: 4px solid #f44336;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .toggle-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 999;
        }
        
        /* Event Details Modal */
        .event-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .event-modal.show {
            display: block;
        }
        .event-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        .event-modal-overlay.show {
            display: block;
        }
        .event-modal h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .event-detail {
            margin: 15px 0;
        }
        .event-detail label {
            font-weight: bold;
            color: #666;
            display: inline-block;
            width: 100px;
        }
        .event-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .event-modal-close:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="info-message" id="message">
                <strong>Add Calendar by URL:</strong><br>
                • Use webcal:// or https:// URLs from Google Calendar, Apple Calendar, Outlook, etc.<br>
                • For Google Calendar: Settings → Integrate → Public/Secret address in iCal format<br>
                • For Apple Calendar: Right-click calendar → Share Settings → Copy webcal:// URL
            </div>

            <div class="control-group">
                <input type="text" id="calendar-url" placeholder="Enter calendar URL (webcal:// or https://)">
                <button onclick="addCalendar()">Add Calendar</button>
            </div>

            <div class="control-group">
                <h3>Active Calendars</h3>
                <div id="active-calendars">
                    <p>No calendars added yet</p>
                </div>
            </div>
        </div>

        <div id="calendar"></div>
        <div class="toggle-hint">Press 'C' to toggle calendar settings</div>
    </div>

    <!-- Event Details Modal -->
    <div class="event-modal-overlay" id="eventModalOverlay"></div>
    <div class="event-modal" id="eventModal">
        <button class="event-modal-close" onclick="closeEventModal()">×</button>
        <h2 id="eventTitle">Event Details</h2>
        <div id="eventDetails"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/icalendar@6.1.19/index.global.min.js"></script>
    
    <script>
        let calendar;
        let eventSources = [];

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',  // Changed to week view
                firstDay: 1, // Start week on Monday (0=Sunday, 1=Monday)
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                height: '100%',
                expandRows: true,
                editable: false,
                selectable: true,
                selectMirror: true,
                eventSources: [],
                eventClick: function(info) {
                    info.jsEvent.preventDefault();
                    showEventDetails(info.event);
                },
                loading: function(isLoading) {
                    const msg = document.getElementById('message');
                    if (isLoading) {
                        msg.innerHTML = '<strong>Loading calendar...</strong>';
                    } else {
                        msg.innerHTML = `
                            <strong>Add Calendar by URL:</strong><br>
                            • Use webcal:// or https:// URLs from Google Calendar, Apple Calendar, Outlook, etc.<br>
                            • For Google Calendar: Settings → Integrate → Public/Secret address in iCal format<br>
                            • For Apple Calendar: Right-click calendar → Share Settings → Copy webcal:// URL
                        `;
                    }
                },
                eventSourceFailure: function(error) {
                    console.error('Calendar load failed:', error);
                    showError('Failed to load calendar. Make sure the URL is correct and accessible.');
                }
            });
            
            calendar.render();
            loadCalendarsFromDB();
        }

        async function loadCalendarsFromDB() {
            try {
                const response = await fetch('/api/calendars');
                if (response.ok) {
                    const calendars = await response.json();
                    calendars.forEach(cal => {
                        let url = cal.url;
                        if (url.startsWith('webcal://')) {
                            url = url.replace('webcal://', 'https://');
                        }
                        const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;
                        const source = {
                            url: proxyUrl,
                            format: 'ics',
                            color: cal.color,
                            textColor: 'white'
                        };
                        const eventSource = calendar.addEventSource(source);
                        eventSources.push({ id: cal.id, url: cal.url, proxyUrl: proxyUrl, color: cal.color, source: eventSource, visible: true });
                    });
                    updateActiveCalendarsList();
                }
            } catch {
                // If API fails, try localStorage as fallback
                loadSavedCalendars();
            }
        }

        async function addCalendar() {
            let url = document.getElementById('calendar-url').value.trim();
            if (!url) {
                showError('Please enter a calendar URL');
                return;
            }
            
            // Convert webcal:// to https:// for proxy
            const originalUrl = url;
            if (url.startsWith('webcal://')) {
                url = url.replace('webcal://', 'https://');
            }
            
            // Use proxy to avoid CORS issues
            const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;
            
            const color = getRandomColor();
            const source = {
                url: proxyUrl,
                format: 'ics',
                color: color,
                textColor: 'white',
                success: function() {
                    console.log('Successfully loaded calendar from: ' + originalUrl);
                },
                failure: function(error) {
                    console.error('Failed to load calendar:', error);
                    showError('Failed to load calendar from: ' + originalUrl);
                }
            };
            
            const eventSource = calendar.addEventSource(source);
            
            // Save to database
            try {
                const response = await fetch('/api/calendars', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: originalUrl, color: color })
                });
                if (response.ok) {
                    const saved = await response.json();
                    eventSources.push({ id: saved.id, url: originalUrl, proxyUrl: proxyUrl, color: color, source: eventSource, visible: true });
                } else {
                    eventSources.push({ url: originalUrl, proxyUrl: proxyUrl, color: color, source: eventSource, visible: true });
                }
            } catch {
                eventSources.push({ url: originalUrl, proxyUrl: proxyUrl, color: color, source: eventSource, visible: true });
            }
            
            // Also save to localStorage as backup
            saveCalendars();
            
            document.getElementById('calendar-url').value = '';
            updateActiveCalendarsList();
        }

        async function removeCalendar(index) {
            const source = eventSources[index];
            
            // Remove from database if it has an ID
            if (source.id) {
                try {
                    await fetch(`/api/calendars/${source.id}`, {
                        method: 'DELETE'
                    });
                } catch {
                    // Continue with local removal
                }
            }
            
            if (source.source) {
                source.source.remove();
            } else {
                calendar.getEventSources().forEach(es => {
                    if (es.url === source.proxyUrl) {
                        es.remove();
                    }
                });
            }
            eventSources.splice(index, 1);
            saveCalendars();
            updateActiveCalendarsList();
        }

        function toggleCalendar(index) {
            const source = eventSources[index];
            source.visible = !source.visible;
            
            if (source.visible) {
                // Re-add the source
                const calSource = {
                    url: source.proxyUrl,
                    format: 'ics',
                    color: source.color,
                    textColor: 'white'
                };
                source.source = calendar.addEventSource(calSource);
            } else {
                // Remove the source
                if (source.source) {
                    source.source.remove();
                }
            }
            
            saveCalendars();
        }

        function updateActiveCalendarsList() {
            const container = document.getElementById('active-calendars');
            if (eventSources.length === 0) {
                container.innerHTML = '<p>No calendars added yet</p>';
                return;
            }
            
            container.innerHTML = eventSources.map((es, index) => `
                <div class="calendar-item">
                    <input type="checkbox" ${es.visible ? 'checked' : ''} onchange="toggleCalendar(${index})">
                    <span style="border-left: 4px solid ${es.color}; padding-left: 8px;">
                        ${es.url}
                    </span>
                    <button class="remove" onclick="removeCalendar(${index})">Remove</button>
                </div>
            `).join('');
        }

        function saveCalendars() {
            const data = eventSources.map(es => ({
                url: es.url,
                color: es.color
            }));
            localStorage.setItem('savedCalendars', JSON.stringify(data));
        }

        function loadSavedCalendars() {
            const saved = localStorage.getItem('savedCalendars');
            if (saved) {
                try {
                    const calendars = JSON.parse(saved);
                    calendars.forEach(cal => {
                        let url = cal.url;
                        if (url.startsWith('webcal://')) {
                            url = url.replace('webcal://', 'https://');
                        }
                        const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;
                        const source = {
                            url: proxyUrl,
                            format: 'ics',
                            color: cal.color || getRandomColor(),
                            textColor: 'white'
                        };
                        const eventSource = calendar.addEventSource(source);
                        eventSources.push({ url: cal.url, proxyUrl: proxyUrl, color: cal.color, source: eventSource, visible: true });
                    });
                    updateActiveCalendarsList();
                } catch (e) {
                    console.error('Error loading saved calendars:', e);
                }
            }
        }

        function getRandomColor() {
            const colors = ['#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336', '#00BCD4', '#795548', '#607D8B'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function showError(message) {
            const container = document.getElementById('message');
            container.className = 'error-message';
            container.innerHTML = `<strong>Error:</strong> ${message}`;
            setTimeout(() => {
                container.className = 'info-message';
                container.innerHTML = `
                    <strong>Add Calendar by URL:</strong><br>
                    • Use webcal:// or https:// URLs from Google Calendar, Apple Calendar, Outlook, etc.<br>
                    • For Google Calendar: Settings → Integrate → Public/Secret address in iCal format<br>
                    • For Apple Calendar: Right-click calendar → Share Settings → Copy webcal:// URL
                `;
            }, 5000);
        }

        // Keyboard shortcut to toggle settings
        document.addEventListener('keydown', function(e) {
            if (e.key === 'c' || e.key === 'C') {
                const controls = document.querySelector('.controls');
                controls.classList.toggle('show');
            }
        });

        // Hide hint after 5 seconds
        setTimeout(() => {
            const hint = document.querySelector('.toggle-hint');
            if (hint) hint.style.display = 'none';
        }, 5000);

        function showEventDetails(event) {
            const modal = document.getElementById('eventModal');
            const overlay = document.getElementById('eventModalOverlay');
            const titleEl = document.getElementById('eventTitle');
            const detailsEl = document.getElementById('eventDetails');
            
            // Set title
            titleEl.textContent = event.title || 'Event Details';
            
            // Format date and time
            const formatDate = (date) => {
                if (!date) return 'N/A';
                return date.toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: event.allDay ? undefined : '2-digit',
                    minute: event.allDay ? undefined : '2-digit'
                });
            };
            
            // Build details HTML
            let detailsHTML = '';
            
            if (event.allDay) {
                detailsHTML += `<div class="event-detail"><label>When:</label> All day event</div>`;
            }
            
            detailsHTML += `<div class="event-detail"><label>Start:</label> ${formatDate(event.start)}</div>`;
            
            if (event.end) {
                detailsHTML += `<div class="event-detail"><label>End:</label> ${formatDate(event.end)}</div>`;
            }
            
            // Duration
            if (event.start && event.end && !event.allDay) {
                const duration = (event.end - event.start) / 1000 / 60; // minutes
                if (duration < 60) {
                    detailsHTML += `<div class="event-detail"><label>Duration:</label> ${duration} minutes</div>`;
                } else {
                    const hours = Math.floor(duration / 60);
                    const mins = duration % 60;
                    detailsHTML += `<div class="event-detail"><label>Duration:</label> ${hours}h ${mins > 0 ? mins + 'm' : ''}</div>`;
                }
            }
            
            // Location (if available in extended props)
            if (event.extendedProps && event.extendedProps.location) {
                detailsHTML += `<div class="event-detail"><label>Location:</label> ${event.extendedProps.location}</div>`;
            }
            
            // Description (if available in extended props)
            if (event.extendedProps && event.extendedProps.description) {
                detailsHTML += `<div class="event-detail"><label>Description:</label><br>${event.extendedProps.description}</div>`;
            }
            
            // Calendar source
            if (event.source) {
                const sourceCalendar = eventSources.find(es => es.proxyUrl === event.source.url);
                if (sourceCalendar) {
                    detailsHTML += `<div class="event-detail"><label>Calendar:</label> <span style="display:inline-block; width:12px; height:12px; background:${sourceCalendar.color}; border-radius:2px;"></span> ${sourceCalendar.url}</div>`;
                }
            }
            
            // URL (if available)
            if (event.url) {
                detailsHTML += `<div class="event-detail"><label>Link:</label> <a href="${event.url}" target="_blank">Open in calendar</a></div>`;
            }
            
            detailsEl.innerHTML = detailsHTML;
            
            // Show modal
            modal.classList.add('show');
            overlay.classList.add('show');
            
            // Close on overlay click
            overlay.onclick = closeEventModal;
        }
        
        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('show');
            document.getElementById('eventModalOverlay').classList.remove('show');
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEventModal();
            }
        });

        // WebSocket connection for live view changes
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectWebSocket() {
            // Only attempt WebSocket connection if not too many failures
            if (reconnectAttempts >= maxReconnectAttempts) {
                console.log('WebSocket disabled after too many failed attempts');
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0; // Reset on successful connection
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'changeView' && data.view) {
                            console.log('Changing view to:', data.view);
                            if (calendar) {
                                calendar.changeView(data.view);
                            }
                        }
                    } catch (error) {
                        console.error('WebSocket message error:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.warn('WebSocket connection failed - this is optional functionality');
                    reconnectAttempts++;
                };
                
                ws.onclose = () => {
                    if (reconnectAttempts < maxReconnectAttempts) {
                        const delay = Math.min(3000 * Math.pow(2, reconnectAttempts), 30000); // Exponential backoff
                        console.log(`WebSocket disconnected, reconnecting in ${delay/1000}s...`);
                        setTimeout(connectWebSocket, delay);
                    }
                };
            } catch (e) {
                console.warn('WebSocket not supported or blocked');
                reconnectAttempts = maxReconnectAttempts; // Stop trying
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCalendar();
            connectWebSocket();
        });
    </script>
</body>
</html>
