{{define "main"}}
<div id="calendar"></div>

<style>
#calendar {
    height: 100vh;
    width: 100vw;
}

.fc .fc-toolbar {
   padding: 10px !important;
}

.event-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 2000;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.event-modal.show {
    display: block;
}

.event-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
}

.event-modal-overlay.show {
    display: block;
}

.event-modal h2 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
}

.event-detail {
    margin: 15px 0;
}

.event-detail label {
    font-weight: bold;
    color: #666;
    display: inline-block;
    width: 100px;
}

.event-modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #f44336;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.event-modal-close:hover {
    background: #da190b;
}

.event-detail a {
    color: #007bff;
    text-decoration: none;
    word-break: break-all;
}

.event-detail a:hover {
    color: #0056b3;
    text-decoration: underline;
}
</style>

<div class="event-modal-overlay" id="eventModalOverlay"></div>
<div class="event-modal" id="eventModal">
    <button class="event-modal-close" onclick="closeEventModal()">Ã—</button>
    <h2 id="eventTitle">Event Details</h2>
    <div id="eventDetails"></div>
</div>

{{template "password-modal" .}}

<script>
let calendar;
let eventSources = [];
let isAuthenticated = false;

function initCalendar() {
    const calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        firstDay: 1,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth settingsButton'
        },
        customButtons: {
            settingsButton: {
                text: 'settings',
                hint: 'Manage Calendars',
                click: function() {
                    window.location.href = '/calendars';
                }
            }
        },
        height: '100%',
        nowIndicator: true,
        expandRows: true,
        editable: false,
        selectable: true,
        selectMirror: true,
        eventSources: [],
        eventClick: function(info) {
            info.jsEvent.preventDefault();

            const eventSourceUrl = info.event.source?.url || info.event.source?.internalEventSource?.meta?.url;
            log.debug('Event source URL:', eventSourceUrl, 'Event color:', info.event.backgroundColor);

            const sourceCalendar = eventSources.find(es => {
                return es.proxyUrl === eventSourceUrl ||
                       es.color === info.event.backgroundColor ||
                       (es.source && es.source.url === eventSourceUrl);
            });

            log.debug('Found calendar:', sourceCalendar, 'Auth:', isAuthenticated);

            if (!isAuthenticated && sourceCalendar && sourceCalendar.details === 1) {
                log.public('Details hidden for public view');
                return;
            }

            showEventDetails(info.event);
        },
        loading: function(isLoading) {
            if (isLoading) {
                log.debug('Loading calendar...');
            }
        },
        eventSourceFailure: function(error) {
            log.error('Calendar load failed:', error);
        }
    });

    calendar.render();
    loadCalendarsFromDB();
}

async function loadCalendarsFromDB() {
    try {
        const response = await fetch('/api/calendars');
        if (response.ok) {
            const calendars = await response.json();
            calendars.forEach(cal => {
                log.debug('Loading calendar:', cal.name || cal.url, 'details value:', cal.details, 'type:', typeof cal.details);
                let url = cal.url;
                if (url.startsWith('webcal://')) {
                    url = url.replace('webcal://', 'https://');
                }
                const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;

                let eventSource = null;
                if (!cal.hidden) {
                    const shouldHideDetails = !isAuthenticated && cal.details === 1;
                    log.debug('Should hide details?', shouldHideDetails, 'for calendar:', cal.name || cal.url, 'Auth:', isAuthenticated, 'Hide for public:', cal.details);

                    const source = {
                        url: proxyUrl,
                        format: 'ics',
                        color: cal.color,
                        textColor: 'white',
                        displayEventTime: shouldHideDetails ? false : true
                    };

                    if (shouldHideDetails) {
                        log.debug('Hiding details for calendar:', cal.name || cal.url);
                        source.eventDataTransform = function(eventData) {
                            eventData.title = '';
                            return eventData;
                        };
                    }

                    eventSource = calendar.addEventSource(source);
                }

                eventSources.push({
                    id: cal.id,
                    url: cal.url,
                    proxyUrl: proxyUrl,
                    color: cal.color,
                    name: cal.name,
                    hidden: cal.hidden,
                    details: cal.details,
                    source: eventSource,
                    visible: !cal.hidden,
                    lastUpdate: new Date(),
                    status: 'fresh'
                });
            });
        }
    } catch (error) {
        log.error('Failed to load calendars from database:', error);
    }
}

function makeLinksClickable(text) {
    if (!text) return text;

    const words = text.split(/(\s+)/);

    return words.map(word => {
        if (/^\s+$/.test(word)) return word;

        let potentialContact = word;
        let trailingPunctuation = '';

        const punctuationMatch = word.match(/^(.+?)([.,;:!?)\]}>]+)$/);
        if (punctuationMatch) {
            potentialContact = punctuationMatch[1];
            trailingPunctuation = punctuationMatch[2];
        }

        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (emailRegex.test(potentialContact)) {
            return `<a href="mailto:${potentialContact}">${potentialContact}</a>${trailingPunctuation}`;
        }

        const phoneRegex = /^(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
        const phoneMatch = potentialContact.match(phoneRegex);
        if (phoneMatch) {
            const cleanPhone = potentialContact.replace(/[^\d+]/g, '');
            return `<a href="tel:${cleanPhone}">${potentialContact}</a>${trailingPunctuation}`;
        }

        try {
            const url = new URL(potentialContact);
            if (url.protocol === 'http:' || url.protocol === 'https:') {
                return `<a href="${url.href}" target="_blank" rel="noopener noreferrer">${potentialContact}</a>${trailingPunctuation}`;
            }
        } catch (e) {}

        return word;
    }).join('');
}

function showEventDetails(event) {
    const modal = document.getElementById('eventModal');
    const overlay = document.getElementById('eventModalOverlay');
    const titleEl = document.getElementById('eventTitle');
    const detailsEl = document.getElementById('eventDetails');

    titleEl.textContent = event.title || 'Event Details';

    const formatDate = (date) => {
        if (!date) return 'N/A';
        return date.toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: event.allDay ? undefined : '2-digit',
            minute: event.allDay ? undefined : '2-digit'
        });
    };

    let detailsHTML = '';

    if (event.allDay) {
        detailsHTML += `<div class="event-detail"><label>When:</label> All day event</div>`;
    }

    detailsHTML += `<div class="event-detail"><label>Start:</label> ${formatDate(event.start)}</div>`;

    if (event.end) {
        detailsHTML += `<div class="event-detail"><label>End:</label> ${formatDate(event.end)}</div>`;
    }

    if (event.start && event.end && !event.allDay) {
        const duration = (event.end - event.start) / 1000 / 60;
        if (duration < 60) {
            detailsHTML += `<div class="event-detail"><label>Duration:</label> ${duration} minutes</div>`;
        } else {
            const hours = Math.floor(duration / 60);
            const mins = duration % 60;
            detailsHTML += `<div class="event-detail"><label>Duration:</label> ${hours}h ${mins > 0 ? mins + 'm' : ''}</div>`;
        }
    }

    if (event.extendedProps && event.extendedProps.location) {
        const locationWithLinks = makeLinksClickable(event.extendedProps.location);
        detailsHTML += `<div class="event-detail"><label>Location:</label> ${locationWithLinks}</div>`;
    }

    if (event.extendedProps && event.extendedProps.description) {
        const descriptionWithLinks = makeLinksClickable(event.extendedProps.description);
        detailsHTML += `<div class="event-detail"><label>Description:</label><br>${descriptionWithLinks}</div>`;
    }

    if (event.source) {
        const sourceCalendar = eventSources.find(es => es.proxyUrl === event.source.url);
        if (sourceCalendar) {
            const calendarDisplayName = sourceCalendar.name || sourceCalendar.url;
            const displayText = sourceCalendar.name ? calendarDisplayName : makeLinksClickable(calendarDisplayName);
            detailsHTML += `<div class="event-detail"><label>Calendar:</label> <span style="display:inline-block; width:12px; height:12px; background:${sourceCalendar.color}; border-radius:2px;"></span> ${displayText}</div>`;
        }
    }

    if (event.url) {
        detailsHTML += `<div class="event-detail"><label>Link:</label> <a href="${event.url}" target="_blank" rel="noopener noreferrer">Open in calendar</a></div>`;
    }

    detailsEl.innerHTML = detailsHTML;

    modal.classList.add('show');
    overlay.classList.add('show');

    overlay.onclick = closeEventModal;
}

function closeEventModal() {
    document.getElementById('eventModal').classList.remove('show');
    document.getElementById('eventModalOverlay').classList.remove('show');
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEventModal();
    }
});

async function checkAuthStatus() {
    try {
        const response = await fetch('/api/auth', {
            credentials: 'include'
        });
        if (response.ok) {
            const data = await response.json();
            isAuthenticated = data.authenticated;
        }
    } catch (error) {
        log.error('Failed to check auth status:', error);
    }
}

async function initializeApp() {
    await checkAuthStatus();
    initCalendar();
}


document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
});
</script>
{{end}}
