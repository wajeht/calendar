{{define "layout"}}
<!DOCTYPE html>
<html lang="en">

{{template "head" .}}

<style>
    .button {
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25em;
        display: inline-block;
        font-size: 1em;
        font-weight: 400;
        height: 38.8px;
        line-height: 1.5;
        padding: 0.4em 0.65em;
        text-align: center;
        user-select: none;
        vertical-align: middle;
        color: white;
    }

    .date {
        font-size: 1.75em;
        font-weight: bold;
        font-family: system-ui, -apple-system, sans-serif;
        line-height: 1.5;
    }

    .view-button.active {
        background-color: #1a252f !important;
        font-weight: bold;
    }
</style>

<body style="display: flex; flex-direction: column; min-height: 100vh; padding: 0px;">
    <header
        style="height: 87px; border-bottom: 1px solid #dddddd; display: flex; justify-content: space-between; padding: 10px;">
        <div style="display: flex; gap: 10px; height: fit-content;">
            <button onclick="navigatePrev()" class="button"
                style="background-color: #2c3e50; color: white;">&lt;</button>
            <button onclick="navigateNext()" class="button"
                style="background-color: #2c3e50; color: white;">&gt;</button>
            <button onclick="navigateToday()" class="button"
                style="background-color: #76828d; color: white;">today</button>
        </div>

        <div id="date" class="date"></div>

        <div style="display: flex; gap: 10px; height: fit-content;">
            <div style="display: flex; color:white; background-color: #2c3e50; border-radius: 5px;">
                <button onclick="changeView('month')" class="button view-button" data-view="month">month</button>
                <button onclick="changeView('week')" class="button view-button" data-view="week">week</button>
                <button onclick="changeView('day')" class="button view-button" data-view="day">day</button>
                <button onclick="changeView('list')" class="button view-button" data-view="list">list</button>
            </div>

            <button type="button" onclick="refetchAllCalendars()" class="button"
                style="background-color: #2c3e50; color: white; text-decoration: none;">
                refetch
            </button>

            <a href="/calendars" class="button"
                style="background-color: #1a252f; color: white; text-decoration: none;">settings</a>
        </div>
    </header>

    <main style="flex: 1; padding: 10px;">
        {{template "main" .}}
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const dateDiv = document.getElementById('date');
            const today = new Date();

            // find this week's Monday
            const day = today.getDay(); // 0 = Sun, 1 = Mon ...
            const diffToMonday = (day === 0 ? -6 : 1) - day;
            const monday = new Date(today);
            monday.setDate(today.getDate() + diffToMonday);

            // this week's Sunday
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const monthStrStart = monday.toLocaleDateString("en-US", { month: "short" });
            const monthStrEnd = sunday.toLocaleDateString("en-US", { month: "short" });
            const startDay = monday.getDate();
            const endDay = sunday.getDate();
            const yearStr = sunday.getFullYear();

            let text;
            if (monthStrStart === monthStrEnd) {
                text = `${monthStrStart} ${startDay} – ${endDay}, ${yearStr}`;
            } else {
                text = `${monthStrStart} ${startDay} – ${monthStrEnd} ${endDay}, ${yearStr}`;
            }

            dateDiv.textContent = text;
        });

        function refetchAllCalendars() {
            if (confirm('Are you sure you want to refetch all calendar data? This may take a moment.')) {
                fetch('/calendars/refetch', {
                    method: 'POST'
                })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error refetching calendars');
                        }
                    })
                    .catch(error => {
                        alert('Error refetching calendars');
                    });
            }
        }

        function navigatePrev() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentDate = urlParams.get('date') || new Date().toISOString().split('T')[0];
            const view = urlParams.get('view') || 'week';

            const date = new Date(currentDate);

            switch (view) {
                case 'day':
                    date.setDate(date.getDate() - 1);
                    break;
                case 'week':
                    date.setDate(date.getDate() - 7);
                    break;
                case 'month':
                    date.setMonth(date.getMonth() - 1);
                    break;
                case 'list':
                    date.setMonth(date.getMonth() - 1);
                    break;
            }

            updateURL(view, date.toISOString().split('T')[0]);
        }

        function navigateNext() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentDate = urlParams.get('date') || new Date().toISOString().split('T')[0];
            const view = urlParams.get('view') || 'week';

            const date = new Date(currentDate);

            switch (view) {
                case 'day':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'week':
                    date.setDate(date.getDate() + 7);
                    break;
                case 'month':
                    date.setMonth(date.getMonth() + 1);
                    break;
                case 'list':
                    date.setMonth(date.getMonth() + 1);
                    break;
            }

            updateURL(view, date.toISOString().split('T')[0]);
        }

        function navigateToday() {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view') || 'week';
            updateURL(view, null); // No date = today
        }

        function changeView(newView) {
            updateURL(newView, null); // No date = current view's date
        }

        function updateURL(view, date) {
            const url = new URL(window.location.origin + '/');
            url.searchParams.set('view', view);
            if (date) {
                url.searchParams.set('date', date);
            }
            window.location.href = url.toString();
        }

        function initializeActiveView() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentView = urlParams.get('view') || 'week';

            document.querySelectorAll('.view-button').forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(`[data-view="${currentView}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeActiveView);
    </script>

    {{template "password-modal" .}}

    <div style="padding: 10px;">
        {{template "footer" .}}
    </div>
</body>

</html>
{{end}}
