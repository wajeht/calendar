<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <link rel="manifest" href="/site.webmanifest">

    <style>
       .fc .fc-toolbar {
           padding: 10px !important;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        .settings-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        .settings-modal-overlay.show {
            display: block;
        }
        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .settings-modal.show {
            display: block;
        }
        .settings-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .settings-modal-close:hover {
            background: #da190b;
        }
        .settings-modal h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group h3 {
            margin-bottom: 10px;
            font-size: 14px;
        }
        .control-group input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            font-size: 14px;
            margin-right: 10px;
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .control-group button {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .control-group button:hover {
            background: #0056b3;
        }
        .control-group button.remove {
            background: #dc3545;
            padding: 6px 10px;
            font-size: 12px;
        }
        .control-group button.remove:hover {
            background: #c82333;
        }
        #calendar {
            height: 100vh;
            width: 100vw;
        }
        .calendar-item {
            padding: 10px;
            margin: 8px 0;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .calendar-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .calendar-item input[type="color"] {
            width: 30px;
            height: 25px;
            border: 1px solid #ddd;
            cursor: pointer;
            padding: 0;
        }
        .calendar-url-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
            max-width: 100%;
        }
        .calendar-url-wrapper {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
        }
        .calendar-item .action-buttons {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .info-message {
            padding: 10px;
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .error-message {
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .keyboard-hint {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 999;
        }

        /* Event Details Modal */
        .event-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .event-modal.show {
            display: block;
        }
        .event-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        .event-modal-overlay.show {
            display: block;
        }
        .event-modal h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .event-detail {
            margin: 15px 0;
        }
        .event-detail label {
            font-weight: bold;
            color: #666;
            display: inline-block;
            width: 100px;
        }
        .event-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .event-modal-close:hover {
            background: #da190b;
        }
        .event-detail a {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
        }
        .event-detail a:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        /* Global Password Modal */
        .password-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
        }
        .password-modal-overlay.show {
            display: block;
        }
        .password-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 3001;
            max-width: 400px;
            width: 90%;
        }
        .password-modal.show {
            display: block;
        }
        .password-modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }
        .password-modal input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        /* Auth status CSS removed per user request */


        .last-update {
            font-size: 11px;
            color: #999;
            margin-left: 5px;
        }
        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background: #218838;
        }
        .refresh-btn.refreshing {
            background: #ffc107;
            cursor: wait;
        }
        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #545b62;
        }
        .copy-btn.copied {
            background: #28a745;
        }
        .edit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .edit-btn:hover {
            background: #138496;
        }
        .calendar-edit-form {
            display: none;
            background: #f8f9fa;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .calendar-edit-form.show {
            display: block;
        }
        .edit-form-group {
            margin-bottom: 10px;
        }
        .edit-form-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .edit-form-group input {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        .edit-form-buttons {
            display: flex;
            gap: 5px;
        }
        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
        }
        .save-btn:hover {
            background: #218838;
        }
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
        }
        .cancel-btn:hover {
            background: #5a6268;
        }
        .refresh-controls {
            margin-bottom: 10px;
        }
        .refresh-controls button {
            margin-right: 10px;
        }
        .refresh-controls label {
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="calendar"></div>
        <div class="keyboard-hint">Press Cmd/Ctrl+K for calendar settings</div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal-overlay" id="settingsModalOverlay"></div>
    <div class="settings-modal" id="settingsModal">
        <button class="settings-modal-close" onclick="closeSettingsModal()">√ó</button>
        <h2>Calendar Settings</h2>

        <div class="control-group">
            <h3>Add New Calendar</h3>
            <div class="input-group">
                <input type="text" id="calendar-name" placeholder="Calendar name (optional)">
            </div>
            <div class="input-group">
                <input type="text" id="calendar-url" placeholder="Enter calendar URL (webcal:// or https://)">
                <button onclick="addCalendar()">Add Calendar</button>
            </div>
            <small style="color: #666; font-size: 12px;">
                Supports Google Calendar, Apple Calendar, Outlook, and other iCal URLs
            </small>
        </div>

        <div class="control-group">
            <h3>Active Calendars</h3>
            <div class="refresh-controls" style="margin-bottom: 15px;">
                <button onclick="refreshAllCalendars()">Refresh All Calendars</button>
            </div>
            <div id="active-calendars" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
                <p style="color: #999; text-align: center; padding: 20px;">No calendars added yet</p>
            </div>
        </div>

        <div id="message" style="display: none;"></div>
    </div>


    <!-- Global Password Modal -->
    <div class="password-modal-overlay" id="passwordModalOverlay"></div>
    <div class="password-modal" id="passwordModal">
        <h2>Authentication Required</h2>
        <div class="password-content">
            <p style="margin-bottom: 20px; color: #666;">Enter password to manage calendars</p>
            <input type="password" id="password-input" placeholder="Enter password" onkeyup="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()" style="margin-top: 15px; width: 100%; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px;">Login</button>
            <div id="password-error" style="color: #dc3545; margin-top: 10px; display: none;">Incorrect password</div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="event-modal-overlay" id="eventModalOverlay"></div>
    <div class="event-modal" id="eventModal">
        <button class="event-modal-close" onclick="closeEventModal()">√ó</button>
        <h2 id="eventTitle">Event Details</h2>
        <div id="eventDetails"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/icalendar@6.1.19/index.global.min.js"></script>

    <script>
        let calendar;
        let eventSources = [];
        let autoRefreshInterval = null;
        const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes default

        const DEBUG = true;

        const log = {
            getTimestamp: () => {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const hour12 = hours % 12 || 12; // Convert to 12-hour format
                return `${hour12}:${minutes}:${seconds} ${ampm}`;
            },
            debug: (...args) => {
                if (DEBUG && isAuthenticated) {
                    console.log(`[${log.getTimestamp()}] [DEBUG]`, ...args);
                }
            },
            error: (...args) => {
                if (DEBUG && isAuthenticated) {
                    console.error(`[${log.getTimestamp()}] [ERROR]`, ...args);
                }
            },
            public: (...args) => {
                if (DEBUG) {
                    console.log(`[${log.getTimestamp()}] [PUBLIC]`, ...args);
                }
            }
        };

        let isAuthenticated = false;

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                firstDay: 1, // Start week on Monday (0=Sunday, 1=Monday)
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                height: '100%',
                nowIndicator: true,
                expandRows: true,
                editable: false,
                selectable: true,
                selectMirror: true,
                eventSources: [],
                eventClick: function(info) {
                    info.jsEvent.preventDefault();

                    // Check if details should be hidden for this calendar
                    // Try to match by the event source URL
                    const eventSourceUrl = info.event.source?.url || info.event.source?.internalEventSource?.meta?.url;
                    log.debug('Event source URL:', eventSourceUrl, 'Event color:', info.event.backgroundColor);

                    const sourceCalendar = eventSources.find(es => {
                        // Match by proxy URL or color
                        return es.proxyUrl === eventSourceUrl ||
                               es.color === info.event.backgroundColor ||
                               (es.source && es.source.url === eventSourceUrl);
                    });

                    log.debug('Found calendar:', sourceCalendar, 'Auth:', isAuthenticated);

                    // If not authenticated and calendar has hide details flag, don't show modal
                    if (!isAuthenticated && sourceCalendar && sourceCalendar.details === 1) {
                        log.public('Details hidden for public view');
                        return;
                    }

                    showEventDetails(info.event);
                },
                loading: function(isLoading) {
                    if (isLoading) {
                        log.debug('Loading calendar...');
                    }
                },
                eventSourceFailure: function(error) {
                    log.error('Calendar load failed:', error);
                    showError('Failed to load calendar. Make sure the URL is correct and accessible.');
                }
            });

            calendar.render();
            loadCalendarsFromDB();
        }

        async function loadCalendarsFromDB() {
            try {
                const response = await fetch('/api/calendars');
                if (response.ok) {
                    const calendars = await response.json();
                    calendars.forEach(cal => {
                        log.debug('Loading calendar:', cal.name || cal.url, 'details value:', cal.details, 'type:', typeof cal.details);
                        let url = cal.url;
                        if (url.startsWith('webcal://')) {
                            url = url.replace('webcal://', 'https://');
                        }
                        const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;

                        // Only add to calendar view if not hidden
                        let eventSource = null;
                        if (!cal.hidden) {
                            // Hide labels only if: not authenticated AND calendar has hide_labels_public flag
                            const shouldHideDetails = !isAuthenticated && cal.details === 1;
                            log.debug('Should hide details?', shouldHideDetails, 'for calendar:', cal.name || cal.url, 'Auth:', isAuthenticated, 'Hide for public:', cal.details);

                            const source = {
                                url: proxyUrl,
                                format: 'ics',
                                color: cal.color,
                                textColor: 'white',
                                displayEventTime: shouldHideDetails ? false : true
                            };

                            if (shouldHideDetails) {
                                log.debug('Hiding details for calendar:', cal.name || cal.url);
                                // Try using eventDataTransform to modify events
                                source.eventDataTransform = function(eventData) {
                                    // Clear the title to hide details
                                    eventData.title = '';
                                    return eventData;
                                };
                            }

                            eventSource = calendar.addEventSource(source);
                        }

                        eventSources.push({
                            id: cal.id,
                            url: cal.url,
                            proxyUrl: proxyUrl,
                            color: cal.color,
                            name: cal.name,
                            hidden: cal.hidden,
                            details: cal.details,
                            source: eventSource,
                            visible: !cal.hidden,
                            lastUpdate: new Date(),
                            status: 'fresh'
                        });
                    });
                    updateActiveCalendarsList();
                }
            } catch (error) {
                log.error('Failed to load calendars from database:', error);
            }
        }

        async function addCalendar() {

            let url = document.getElementById('calendar-url').value.trim();
            let name = document.getElementById('calendar-name').value.trim();
            if (!url) {
                showError('Please enter a calendar URL');
                return;
            }

            const originalUrl = url;
            if (url.startsWith('webcal://')) {
                url = url.replace('webcal://', 'https://');
            }

            const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;

            const color = getRandomColor();
            const source = {
                url: proxyUrl,
                format: 'ics',
                color: color,
                textColor: 'white',
                success: function() {
                    log.debug('Successfully loaded calendar from: ' + originalUrl);
                },
                failure: function(error) {
                    log.error('Failed to load calendar:', error);
                    showError('Failed to load calendar from: ' + originalUrl);
                }
            };

            const eventSource = calendar.addEventSource(source);

            try {
                const response = await fetch('/api/calendars', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: originalUrl,
                        color: color,
                        name: name || null,
                        hidden: 0,
                        details: 0
                    })
                });

                if (response.status === 401) {
                    if (!isAuthenticated) {
                        showPasswordModal();
                    }
                    return;
                }

                if (response.ok) {
                    const saved = await response.json();
                        eventSources.push({
                            id: saved.id,
                            url: originalUrl,
                            proxyUrl: proxyUrl,
                            color: color,
                            name: name || null,
                            hidden: saved.hidden || 0,
                            details: saved.details || 0,
                            source: eventSource,
                            visible: true,
                            lastUpdate: new Date(),
                            status: 'fresh'
                        });
                } else {
                    eventSources.push({
                        url: originalUrl,
                        proxyUrl: proxyUrl,
                        color: color,
                        name: name || null,
                        hidden: 0,
                        details: 0,
                        source: eventSource,
                        visible: true,
                        lastUpdate: new Date(),
                        status: 'fresh'
                    });
                }
            } catch {
                eventSources.push({
                    url: originalUrl,
                    proxyUrl: proxyUrl,
                    color: color,
                    name: name || null,
                    hidden: 0,
                    details: 0,
                    source: eventSource,
                    visible: true,
                    lastUpdate: new Date(),
                    status: 'fresh'
                });
            }

            document.getElementById('calendar-url').value = '';
            document.getElementById('calendar-name').value = '';
            updateActiveCalendarsList();
        }

        async function removeCalendar(index) {

            const source = eventSources[index];

            if (source.id) {
                try {
                    const response = await fetch(`/api/calendars/${source.id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.status === 401) {
                        if (!isAuthenticated) {
                            showPasswordModal();
                        }
                        return;
                    }
                } catch {
                }
            }

            if (source.source) {
                source.source.remove();
            } else {
                calendar.getEventSources().forEach(es => {
                    if (es.url === source.proxyUrl) {
                        es.remove();
                    }
                });
            }
            eventSources.splice(index, 1);
            updateActiveCalendarsList();
        }

        function toggleCalendar(index) {
            const source = eventSources[index];
            source.visible = !source.visible;

            if (source.visible) {
                // Hide details only for public/unauthenticated users if flag is set
                const shouldHideDetails = !isAuthenticated && source.details === 1;

                const calSource = {
                    url: source.proxyUrl,
                    format: 'ics',
                    color: source.color,
                    textColor: 'white',
                    displayEventTime: shouldHideDetails ? false : true
                };

                if (shouldHideDetails) {
                    log.debug('Toggling calendar with details hidden:', source.name || source.url);
                    // Clear titles when hiding details
                    calSource.eventDataTransform = function(eventData) {
                        eventData.title = '';
                        return eventData;
                    };
                }
                source.source = calendar.addEventSource(calSource);
            } else {
                if (source.source) {
                    source.source.remove();
                }
            }

            saveCalendars();
        }

        function updateActiveCalendarsList() {
            const container = document.getElementById('active-calendars');
            if (eventSources.length === 0) {
                container.innerHTML = '<p>No calendars added yet</p>';
                return;
            }

            container.innerHTML = eventSources.map((es, index) => {
                const timeSinceUpdate = es.lastUpdate ?
                    Math.floor((new Date() - es.lastUpdate) / 60000) : 0;

                const displayName = es.name || es.url;
                const titleText = es.name ? `${es.name} (${es.url})` : es.url;

                return `
                <div class="calendar-item" id="calendar-item-${index}">
                    <input type="checkbox" ${es.visible ? 'checked' : ''} onchange="toggleCalendar(${index})">
                    <input type="color" value="${es.color}" onchange="changeCalendarColor(${index}, this.value)" title="Change calendar color">
                    <div class="calendar-url-wrapper">
                        <span class="calendar-url-text" title="${titleText}">${displayName}</span>
                        <span class="last-update">
                            ${es.lastUpdate ?
                                `(${timeSinceUpdate === 0 ? 'now' :
                                timeSinceUpdate + 'min'})` : ''}
                        </span>
                    </div>
                    <div class="action-buttons">
                        <button class="edit-btn" onclick="editCalendar(${index})" id="edit-${index}" title="Edit calendar">‚úèÔ∏è</button>
                        <button class="copy-btn" onclick="copyCalendarUrl(${index})" id="copy-${index}" title="Copy URL">üìã</button>
                        <button class="refresh-btn" onclick="refreshCalendar(${index})" id="refresh-${index}">‚Üª</button>
                        <button class="remove" onclick="removeCalendar(${index})">‚úï</button>
                    </div>
                    <div class="calendar-edit-form" id="edit-form-${index}">
                        <div class="edit-form-group">
                            <label for="edit-name-${index}">Calendar Name:</label>
                            <input type="text" id="edit-name-${index}" value="${es.name || ''}" placeholder="Enter calendar name (optional)">
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-url-${index}">Calendar URL:</label>
                            <input type="text" id="edit-url-${index}" value="${es.url}" placeholder="Enter calendar URL">
                        </div>
                        <div class="edit-form-group">
                            <label>
                                <input type="checkbox" id="edit-hidden-${index}" ${es.hidden ? 'checked' : ''}>
                                Hide calendar (doesn't show up publicly)
                            </label>
                        </div>
                        <div class="edit-form-group">
                            <label>
                                <input type="checkbox" id="edit-hide-details-${index}" ${es.details === 1 ? 'checked' : ''}>
                                Hide details for public (show as time blocks only)
                            </label>
                        </div>
                        <div class="edit-form-buttons">
                            <button class="save-btn" onclick="saveCalendarEdit(${index})">Save</button>
                            <button class="cancel-btn" onclick="cancelCalendarEdit(${index})">Cancel</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }


        function getRandomColor() {
            const colors = ['#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336', '#00BCD4', '#795548', '#607D8B'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function showError(message) {
            const container = document.getElementById('message');
            container.style.display = 'block';
            container.className = 'error-message';
            container.innerHTML = `<strong>Error:</strong> ${message}`;
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }

        function openSettingsModal() {
            if (!isAuthenticated) {
                showPasswordModal();
                return;
            }

            document.getElementById('settingsModal').classList.add('show');
            document.getElementById('settingsModalOverlay').classList.add('show');
            updateActiveCalendarsList();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
            document.getElementById('settingsModalOverlay').classList.remove('show');
        }

        document.addEventListener('keydown', function(e) {
            // Cmd/Ctrl + K for settings
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                openSettingsModal();
            }
            if (e.key === 'Escape') {
                closeSettingsModal();
                closeEventModal();
                closePasswordModal();
            }
        });

        document.getElementById('settingsModalOverlay').addEventListener('click', closeSettingsModal);

        setTimeout(() => {
            const hint = document.querySelector('.keyboard-hint');
            if (hint) hint.style.display = 'none';
        }, 5000);

        function makeLinksClickable(text) {
            if (!text) return text;

            // Split text by whitespace to check each potential URL/contact
            const words = text.split(/(\s+)/);

            return words.map(word => {
                // Skip whitespace
                if (/^\s+$/.test(word)) return word;

                // Try to parse as URL/contact, handling common punctuation at the end
                let potentialContact = word;
                let trailingPunctuation = '';

                // Extract trailing punctuation that's likely not part of the URL/contact
                const punctuationMatch = word.match(/^(.+?)([.,;:!?)\]}>]+)$/);
                if (punctuationMatch) {
                    potentialContact = punctuationMatch[1];
                    trailingPunctuation = punctuationMatch[2];
                }

                // Check for email addresses
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (emailRegex.test(potentialContact)) {
                    return `<a href="mailto:${potentialContact}">${potentialContact}</a>${trailingPunctuation}`;
                }

                // Check for phone numbers (various formats)
                const phoneRegex = /^(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
                const phoneMatch = potentialContact.match(phoneRegex);
                if (phoneMatch) {
                    // Clean phone number for tel: link (remove formatting)
                    const cleanPhone = potentialContact.replace(/[^\d+]/g, '');
                    return `<a href="tel:${cleanPhone}">${potentialContact}</a>${trailingPunctuation}`;
                }

                // Try to parse as URL
                try {
                    const url = new URL(potentialContact);
                    // Convert http and https URLs to links
                    if (url.protocol === 'http:' || url.protocol === 'https:') {
                        return `<a href="${url.href}" target="_blank" rel="noopener noreferrer">${potentialContact}</a>${trailingPunctuation}`;
                    }
                } catch (e) {
                    // Not a valid URL, continue checking other patterns
                }

                return word;
            }).join('');
        }

        function showEventDetails(event) {
            const modal = document.getElementById('eventModal');
            const overlay = document.getElementById('eventModalOverlay');
            const titleEl = document.getElementById('eventTitle');
            const detailsEl = document.getElementById('eventDetails');

            titleEl.textContent = event.title || 'Event Details';

            const formatDate = (date) => {
                if (!date) return 'N/A';
                return date.toLocaleString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: event.allDay ? undefined : '2-digit',
                    minute: event.allDay ? undefined : '2-digit'
                });
            };

            let detailsHTML = '';

            if (event.allDay) {
                detailsHTML += `<div class="event-detail"><label>When:</label> All day event</div>`;
            }

            detailsHTML += `<div class="event-detail"><label>Start:</label> ${formatDate(event.start)}</div>`;

            if (event.end) {
                detailsHTML += `<div class="event-detail"><label>End:</label> ${formatDate(event.end)}</div>`;
            }

            // Duration
            if (event.start && event.end && !event.allDay) {
                const duration = (event.end - event.start) / 1000 / 60; // minutes
                if (duration < 60) {
                    detailsHTML += `<div class="event-detail"><label>Duration:</label> ${duration} minutes</div>`;
                } else {
                    const hours = Math.floor(duration / 60);
                    const mins = duration % 60;
                    detailsHTML += `<div class="event-detail"><label>Duration:</label> ${hours}h ${mins > 0 ? mins + 'm' : ''}</div>`;
                }
            }

            // Location (if available in extended props)
            if (event.extendedProps && event.extendedProps.location) {
                const locationWithLinks = makeLinksClickable(event.extendedProps.location);
                detailsHTML += `<div class="event-detail"><label>Location:</label> ${locationWithLinks}</div>`;
            }

            // Description (if available in extended props)
            if (event.extendedProps && event.extendedProps.description) {
                const descriptionWithLinks = makeLinksClickable(event.extendedProps.description);
                detailsHTML += `<div class="event-detail"><label>Description:</label><br>${descriptionWithLinks}</div>`;
            }

            // Calendar source
            if (event.source) {
                const sourceCalendar = eventSources.find(es => es.proxyUrl === event.source.url);
                if (sourceCalendar) {
                    const calendarDisplayName = sourceCalendar.name || sourceCalendar.url;
                    // Make the calendar URL clickable if it's showing the URL instead of a name
                    const displayText = sourceCalendar.name ? calendarDisplayName : makeLinksClickable(calendarDisplayName);
                    detailsHTML += `<div class="event-detail"><label>Calendar:</label> <span style="display:inline-block; width:12px; height:12px; background:${sourceCalendar.color}; border-radius:2px;"></span> ${displayText}</div>`;
                }
            }

            // URL (if available)
            if (event.url) {
                detailsHTML += `<div class="event-detail"><label>Link:</label> <a href="${event.url}" target="_blank" rel="noopener noreferrer">Open in calendar</a></div>`;
            }

            detailsEl.innerHTML = detailsHTML;

            modal.classList.add('show');
            overlay.classList.add('show');

            overlay.onclick = closeEventModal;
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('show');
            document.getElementById('eventModalOverlay').classList.remove('show');
        }


        async function refreshCalendar(index) {
            const source = eventSources[index];
            const btn = document.getElementById(`refresh-${index}`);

            if (!source || !source.visible) return;

            if (btn) {
                btn.classList.add('refreshing');
                btn.textContent = 'Refreshing...';
            }

            try {
                if (source.source) {
                    source.source.remove();
                }

                // Hide details only for public/unauthenticated users if flag is set
                const shouldHideDetails = !isAuthenticated && source.details === 1;

                const calSource = {
                    url: source.proxyUrl,
                    format: 'ics',
                    color: source.color,
                    textColor: 'white',
                    displayEventTime: shouldHideDetails ? false : true,
                    success: function() {
                        source.lastUpdate = new Date();
                        source.status = 'fresh';
                        updateActiveCalendarsList();
                    },
                    failure: function() {
                        source.status = 'error';
                        updateActiveCalendarsList();
                        showError(`Failed to refresh calendar: ${source.url}`);
                    }
                };

                if (shouldHideDetails) {
                    log.debug('Refreshing calendar with details hidden:', source.name || source.url);
                    // Clear titles when hiding details
                    calSource.eventDataTransform = function(eventData) {
                        eventData.title = '';
                        return eventData;
                    };
                }

                source.source = calendar.addEventSource(calSource);
                source.lastUpdate = new Date();
                source.status = 'fresh';

            } catch (error) {
                source.status = 'error';
                showError(`Error refreshing calendar: ${error.message}`);
            } finally {
                if (btn) {
                    btn.classList.remove('refreshing');
                    btn.textContent = 'Refresh';
                }
                updateActiveCalendarsList();
            }
        }

        async function refreshAllCalendars() {
            const visibleCalendars = eventSources
                .map((es, index) => ({ ...es, index }))
                .filter(es => es.visible);

            if (visibleCalendars.length === 0) {
                showError('No calendars to refresh');
                return;
            }

            showMessage('Refreshing all calendars...');

            for (const cal of visibleCalendars) {
                await refreshCalendar(cal.index);
            }

            showMessage(`All calendars refreshed at ${new Date().toLocaleTimeString()}`);
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');

            if (checkbox.checked) {
                // Just use setTimeout for refresh instead of interval
                refreshAllCalendars();
                showMessage('Calendars refreshed');
            }
        }

        function showMessage(message) {
            const container = document.getElementById('message');
            container.style.display = 'block';
            container.className = 'info-message';
            container.innerHTML = `<strong>${message}</strong>`;
            setTimeout(() => {
                container.style.display = 'none';
            }, 3000);
        }

        setInterval(() => {
            updateActiveCalendarsList();
        }, 60000);

        async function changeCalendarColor(index, newColor) {
            const source = eventSources[index];
            if (!source) return;

            source.color = newColor;

            if (source.visible && source.source) {
                source.source.remove();

                const calSource = {
                    url: source.proxyUrl,
                    format: 'ics',
                    color: newColor,
                    textColor: 'white'
                };
                source.source = calendar.addEventSource(calSource);
            }

            if (source.id) {
                try {
                    await fetch(`/api/calendars/${source.id}`, {
                        method: 'PATCH',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ color: newColor })
                    });
                } catch (error) {
                    log.error('Failed to update color in database:', error);
                }
            }

            saveCalendars();

            updateActiveCalendarsList();
        }

        async function copyCalendarUrl(index) {
            const source = eventSources[index];
            if (!source) return;

            const btn = document.getElementById(`copy-${index}`);

            try {
                await navigator.clipboard.writeText(source.url);

                // Provide visual feedback
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì';
                    btn.classList.add('copied');

                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('copied');
                    }, 1500);
                }

                showMessage('Calendar URL copied to clipboard!');
            } catch (error) {
                log.error('Failed to copy URL:', error);

                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = source.url;
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    showMessage('Calendar URL copied to clipboard!');

                    if (btn) {
                        const originalText = btn.textContent;
                        btn.textContent = '‚úì';
                        btn.classList.add('copied');

                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.classList.remove('copied');
                        }, 1500);
                    }
                } catch (fallbackError) {
                    showError('Failed to copy URL to clipboard');
                }

                document.body.removeChild(textArea);
            }
        }

        function editCalendar(index) {

            const editForm = document.getElementById(`edit-form-${index}`);
            const isShowing = editForm.classList.contains('show');

            // Hide all other edit forms
            document.querySelectorAll('.calendar-edit-form.show').forEach(form => {
                form.classList.remove('show');
            });

            // Toggle this form
            if (!isShowing) {
                editForm.classList.add('show');
            }
        }


        function cancelCalendarEdit(index) {
            const editForm = document.getElementById(`edit-form-${index}`);
            editForm.classList.remove('show');

            // Reset form values to original
            const source = eventSources[index];
            document.getElementById(`edit-name-${index}`).value = source.name || '';
            document.getElementById(`edit-url-${index}`).value = source.url;
            document.getElementById(`edit-hidden-${index}`).checked = source.hidden || false;
            document.getElementById(`edit-hide-details-${index}`).checked = source.details === 1;
        }

        async function saveCalendarEdit(index) {

            const source = eventSources[index];
            if (!source) return;

            const newName = document.getElementById(`edit-name-${index}`).value.trim();
            const newUrl = document.getElementById(`edit-url-${index}`).value.trim();
            const isHidden = document.getElementById(`edit-hidden-${index}`).checked;
            const isHideDetails = document.getElementById(`edit-hide-details-${index}`).checked;

            if (!newUrl) {
                showError('Calendar URL is required');
                return;
            }

            // Validate URL format
            try {
                new URL(newUrl);
            } catch (e) {
                showError('Please enter a valid URL');
                return;
            }

            const updates = {
                name: newName || null,
                url: newUrl,
                hidden: isHidden ? 1 : 0,
                details: isHideDetails ? 1 : 0
            };

            try {
                // Update in database if it has an ID
                if (source.id) {
                    const response = await fetch(`/api/calendars/${source.id}`, {
                        method: 'PATCH',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    });

                    if (response.status === 401) {
                        // Only show password modal if we don't have a password yet
                        if (!isAuthenticated) {
                            showPasswordModal();
                        }
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('Failed to update calendar');
                    }
                }

                // Update local data
                const wasHidden = source.hidden;
                const wasHideDetails = source.details;
                source.name = updates.name;
                source.hidden = updates.hidden;
                source.details = updates.details;
                const oldUrl = source.url;
                source.url = updates.url;

                // Handle visibility changes
                if (wasHidden !== updates.hidden) {
                    if (updates.hidden) {
                        // Calendar was visible, now hidden - remove from calendar view
                        if (source.source) {
                            source.source.remove();
                            source.source = null;
                            source.visible = false;
                        }
                    } else {
                        // Calendar was hidden, now visible - add to calendar view
                        if (!source.source) {
                            let url = updates.url;
                            if (url.startsWith('webcal://')) {
                                url = url.replace('webcal://', 'https://');
                            }
                            const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;
                            source.proxyUrl = proxyUrl;
                            const calSource = {
                                url: proxyUrl,
                                format: 'ics',
                                color: source.color,
                                textColor: 'white',
                            };

                            source.source = calendar.addEventSource(calSource);
                            source.visible = true;
                        }
                    }
                }
                // Handle details hiding changes for visible calendars
                else if (!updates.hidden && (wasHideDetails !== updates.details || oldUrl !== newUrl)) {
                    // Refresh the calendar source to apply details changes or URL changes
                    if (source.source) {
                        source.source.remove();
                        let url = updates.url;
                        if (url.startsWith('webcal://')) {
                            url = url.replace('webcal://', 'https://');
                        }
                        const proxyUrl = `/api/proxy-ical?url=${encodeURIComponent(url)}`;
                        source.proxyUrl = proxyUrl;
                        const calSource = {
                            url: proxyUrl,
                            format: 'ics',
                            color: source.color,
                            textColor: 'white',
                        };

                        source.source = calendar.addEventSource(calSource);
                    }
                }

                // Hide edit form and refresh display
                document.getElementById(`edit-form-${index}`).classList.remove('show');
                updateActiveCalendarsList();

                showMessage('Calendar updated successfully!');
            } catch (error) {
                log.error('Failed to update calendar:', error);
                showError('Failed to update calendar');
            }
        }

        let ws;
        let wsConnectionAttempted = false;

        function connectWebSocket() {
            if (wsConnectionAttempted) {
                return;
            }
            wsConnectionAttempted = true;

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            try {
                ws = new WebSocket(wsUrl);

                let connectionTimeout = setTimeout(() => {
                    if (ws.readyState !== WebSocket.OPEN) {
                        ws.close();
                    }
                }, 3000);

                ws.onopen = () => {
                    clearTimeout(connectionTimeout);
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'changeView' && data.view) {
                            if (calendar) {
                                calendar.changeView(data.view);
                            }
                        }
                    } catch (error) {}
                };

                ws.onerror = () => {};
                ws.onclose = () => {};
            } catch (e) {}
        }


        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    isAuthenticated = data.authenticated;
                }
            } catch (error) {
                log.error('Failed to check auth status:', error);
            }
        }

        async function initializeApp() {
            await checkAuthStatus();
            initCalendar();
            connectWebSocket();
        }

        // Global authentication functions
        async function checkPassword() {
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');

            try {
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    isAuthenticated = true;
                    closePasswordModal();
                    showMessage('Authentication successful');
                    // Reload calendars to show labels after authentication
                    refreshAllCalendars();
                    // Now open the settings modal that the user wanted
                    setTimeout(() => {
                        openSettingsModal();
                    }, 100);
                } else {
                    errorEl.style.display = 'block';
                    document.getElementById('password-input').value = '';
                    document.getElementById('password-input').focus();
                }
            } catch (error) {
                showError('Authentication failed');
            }
        }

        function showPasswordModal() {
            const modal = document.getElementById('passwordModal');
            const overlay = document.getElementById('passwordModalOverlay');

            modal.classList.add('show');
            overlay.classList.add('show');

            // Clear previous input and error
            document.getElementById('password-input').value = '';
            document.getElementById('password-error').style.display = 'none';
            document.getElementById('password-input').focus();

            // Don't close on overlay click to force authentication
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('show');
            document.getElementById('passwordModalOverlay').classList.remove('show');
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
    </script>
</body>
</html>
